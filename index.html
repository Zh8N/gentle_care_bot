<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Balance Care</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --bg: #f6f7fb;
      --card: rgba(255,255,255,0.92);
      --card2: rgba(255,255,255,0.78);
      --stroke: rgba(15,23,42,0.10);
      --text: rgba(15,23,42,0.92);
      --muted: rgba(15,23,42,0.62);

      --primary: #2563eb;
      --primary2:#1d4ed8;

      --neutralText: rgba(15,23,42,0.82);

      --shadow: 0 14px 40px rgba(15,23,42,0.10);
      --radius: 22px;
    }

    html[data-theme="dark"]{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);

      --neutralText: rgba(255,255,255,0.88);
      --shadow: 0 18px 50px rgba(0,0,0,0.35);
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(37,99,235,0.10), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(29,78,216,0.10), transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    .app-wrap{
      padding-top: calc(14px + var(--safe-top));
      padding-bottom: calc(18px + var(--safe-bottom));
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .segmented{
      background: rgba(255,255,255,0.55);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 6px;
      display:flex;
      gap: 6px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    html[data-theme="dark"] .segmented{ background: rgba(255,255,255,0.06); }

    .tab-btn{
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
      border: 1px solid transparent;
      color: var(--muted);
      background: transparent;
      transition: transform .06s ease, background .18s ease, color .18s ease, border-color .18s ease;
      user-select: none;
      -webkit-user-select: none;
    }
    .tab-btn:active{ transform: scale(0.99); }
    .tab-btn.active{
      color: white;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-color: rgba(255,255,255,0.18);
      box-shadow: 0 10px 26px rgba(37,99,235,0.22);
    }

    .action-btn{
      width: 100%;
      border-radius: 20px;
      padding: 18px 16px;
      font-size: 18px;
      font-weight: 650;
      border: 1px solid var(--stroke);
      transition: transform .06s ease, filter .08s ease;
      user-select: none;
      -webkit-user-select: none;
    }
    .action-btn:active{ transform: translateY(1px); filter: brightness(0.98); }

    .action-primary{
      color: white;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-color: rgba(255,255,255,0.18);
      box-shadow: 0 14px 34px rgba(37,99,235,0.26);
    }

    .action-neutral{
      color: var(--neutralText);
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.45));
    }
    html[data-theme="dark"] .action-neutral{
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
    }

    .dot-row{ display:flex; gap:8px; flex-wrap: wrap; padding-top: 6px; }
    .dot{
      width: 16px; height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 8px 20px rgba(15,23,42,0.06);
    }
    html[data-theme="dark"] .dot{
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 8px 20px rgba(0,0,0,0.22);
    }
    .dot.good{ background: var(--primary); }
    .dot.pause{ background: rgba(148,163,184,0.95); }
    html[data-theme="dark"] .dot.pause{ background: rgba(203,213,225,0.55); }

    .small-muted{ color: var(--muted); font-size: 13px; line-height: 1.35; }

    #todayMicrocopy{
      letter-spacing: 0.005em;
      font-style: italic;
      opacity: 0.95;
      white-space: pre-wrap;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      font-size: 13px;
      color: var(--muted);
    }
    html[data-theme="dark"] .pill{ background: rgba(255,255,255,0.06); }

    .pill-good{
      border-color: rgba(37,99,235,0.25);
      background: rgba(37,99,235,0.10);
      color: rgba(15,23,42,0.82);
    }
    html[data-theme="dark"] .pill-good{
      background: rgba(37,99,235,0.18);
      color: rgba(255,255,255,0.88);
      border-color: rgba(37,99,235,0.28);
    }

    .pill-pause{
      border-color: rgba(148,163,184,0.30);
      background: rgba(148,163,184,0.18);
      color: rgba(15,23,42,0.78);
    }
    html[data-theme="dark"] .pill-pause{
      background: rgba(203,213,225,0.12);
      color: rgba(255,255,255,0.86);
      border-color: rgba(203,213,225,0.18);
    }

    .surprise{
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px dashed rgba(37,99,235,0.28);
      background: radial-gradient(900px 260px at 20% 0%, rgba(37,99,235,0.10), transparent 55%),
                  rgba(255,255,255,0.55);
      color: rgba(15,23,42,0.82);
    }
    html[data-theme="dark"] .surprise{
      background: radial-gradient(900px 260px at 20% 0%, rgba(37,99,235,0.18), transparent 55%),
                  rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.86);
      border-color: rgba(37,99,235,0.28);
    }

    .breath-wrap{
      display:flex; flex-direction:column; align-items:center; gap: 12px;
      padding: 10px 0 2px;
    }

    .breath-shadow{
      filter: drop-shadow(0 22px 60px rgba(37,99,235,0.18));
      -webkit-filter: drop-shadow(0 22px 60px rgba(37,99,235,0.18));
    }
    html[data-theme="dark"] .breath-shadow{
      filter: drop-shadow(0 26px 70px rgba(0,0,0,0.45));
      -webkit-filter: drop-shadow(0 26px 70px rgba(0,0,0,0.45));
    }

    .breath-circle{
      position: relative;
      width: 190px;
      height: 190px;

      border-radius: 9999px;
      overflow: hidden;

      -webkit-mask-image: radial-gradient(circle at center, #000 99.4%, transparent 100%);
      mask-image: radial-gradient(circle at center, #000 99.4%, transparent 100%);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: cover;
      mask-size: cover;

      display:flex; align-items:center; justify-content:center;
      color: white;
      font-weight: 700;
      letter-spacing: -0.02em;

      transform: translateZ(0) scale(0.78);
      will-change: transform;
      backface-visibility: hidden;

      border: 1px solid rgba(255,255,255,0.14);
      user-select:none;
      -webkit-user-select:none;
      background: rgba(37,99,235,0.95);
    }

    .breath-circle::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      background: conic-gradient(from 180deg,
        rgba(37,99,235,1),
        rgba(29,78,216,1),
        rgba(124,58,237,1),
        rgba(37,99,235,1)
      );
      animation: spin 10s linear infinite;
      opacity: 0.98;
      transform: translateZ(0);
    }

    .breath-circle::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      background: radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,0.28), transparent 60%),
                  rgba(0,0,0,0.10);
      mix-blend-mode: soft-light;
      transform: translateZ(0);
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .breath-circle > span{
      position: relative;
      z-index: 2;
      text-align:center;
      padding: 0 12px;
    }

    .breath-sub{
      font-size: 14px;
      color: var(--muted);
      text-align:center;
    }

    .ghost-btn{
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--text);
      font-size: 14px;
      transition: transform .06s ease, background .16s ease, opacity .16s ease;
      user-select:none; -webkit-user-select:none;
    }
    html[data-theme="dark"] .ghost-btn{ background: rgba(255,255,255,0.06); }
    .ghost-btn:active{ transform: translateY(1px); }

    .export-box{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,0.55);
      padding: 12px 14px;
    }
    html[data-theme="dark"] .export-box{ background: rgba(255,255,255,0.06); }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-bottom));
      z-index: 50;
      width: min(92vw, 420px);
      display:none;
    }
    .toast.show{ display:block; }
    .toast .inner{
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.75);
      box-shadow: 0 18px 50px rgba(15,23,42,0.12);
      color: rgba(15,23,42,0.88);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-size: 14px;
    }
    html[data-theme="dark"] .toast .inner{
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.90);
      box-shadow: 0 18px 50px rgba(0,0,0,0.38);
    }

    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.40);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      padding: 14px;
    }
    .modal-overlay.show{ display: flex; }
    .modal-card{
      width: min(92vw, 420px);
      padding: 14px;
    }

    .event-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:100%;
      text-align:left;
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--text);
      font-size: 14px;
      user-select:none; -webkit-user-select:none;
      transition: transform .06s ease, background .16s ease;
    }
    html[data-theme="dark"] .event-row{ background: rgba(255,255,255,0.06); }
    .event-row:active{ transform: translateY(1px); }

    .event-row.good-bg{
      border-color: rgba(37,99,235,0.22);
      background: rgba(37,99,235,0.10);
    }
    html[data-theme="dark"] .event-row.good-bg{
      border-color: rgba(37,99,235,0.28);
      background: rgba(37,99,235,0.14);
    }

    .event-row.pause-bg{
      border-color: rgba(148,163,184,0.26);
      background: rgba(148,163,184,0.16);
    }
    html[data-theme="dark"] .event-row.pause-bg{
      border-color: rgba(203,213,225,0.16);
      background: rgba(203,213,225,0.10);
    }

    .event-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .event-badge{
      width:12px; height:12px; border-radius:999px;
      flex: 0 0 auto;
      border: 1px solid rgba(0,0,0,0.06);
    }
    html[data-theme="dark"] .event-badge{ border: 1px solid rgba(255,255,255,0.10); }
    .event-badge.good{ background: var(--primary); }
    .event-badge.pause{ background: rgba(148,163,184,0.95); }
    html[data-theme="dark"] .event-badge.pause{ background: rgba(203,213,225,0.55); }

    .event-title{ font-weight:650; letter-spacing:-0.01em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .event-sub{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .event-right{ flex:0 0 auto; font-size:12px; color: var(--muted); }

    /* –õ–µ–≥–µ–Ω–¥–∞ */
    .legend{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 8px;
    }
    .legend span{
      display:inline-flex; align-items:center; gap:6px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.45);
    }
    html[data-theme="dark"] .legend span{ background: rgba(255,255,255,0.06); }

    /* ‚úÖ –ù–û–í–û–ï: –º–∏–Ω–∏-–ø–æ–ª–æ—Å–∫–∏ */
    .areas-wrap{
      margin-top: 10px;
      border: 1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(255,255,255,0.45);
      padding: 12px;
    }
    html[data-theme="dark"] .areas-wrap{
      background: rgba(255,255,255,0.06);
    }

    .areas-title{
      font-weight: 650;
      letter-spacing: -0.01em;
      margin-bottom: 8px;
      font-size: 14px;
      color: rgba(15,23,42,0.86);
    }
    html[data-theme="dark"] .areas-title{
      color: rgba(255,255,255,0.88);
    }

    .area-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid transparent;
    }
    .area-row + .area-row{ margin-top: 6px; }

    .area-label{
      min-width: 0;
      font-size: 13px;
      color: rgba(15,23,42,0.86);
      line-height: 1.25;
    }
    html[data-theme="dark"] .area-label{
      color: rgba(255,255,255,0.88);
    }

    .bars{
      display:flex;
      flex-direction:column;
      gap: 6px;
      flex: 0 0 auto;
      min-width: 148px;
      align-items:flex-end;
    }

    .barline{
      display:flex;
      align-items:center;
      gap: 8px;
      justify-content:flex-end;
    }

    .barbadge{
      font-size: 12px;
      color: var(--muted);
      width: 26px;
      text-align:right;
    }

    .mini-bar{
      display:flex;
      gap: 4px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.40);
    }
    html[data-theme="dark"] .mini-bar{
      background: rgba(255,255,255,0.06);
    }

    .sq{
      width: 10px;
      height: 10px;
      border-radius: 3px;
      opacity: 0.95;
    }
    .sq.good{ background: var(--primary); }
    .sq.pause{ background: rgba(148,163,184,0.95); }
    html[data-theme="dark"] .sq.pause{ background: rgba(203,213,225,0.55); }

    .sq.empty{
      background: rgba(148,163,184,0.18);
    }
    html[data-theme="dark"] .sq.empty{
      background: rgba(203,213,225,0.10);
    }
  </style>
</head>

<body>
  <div class="app-wrap max-w-md mx-auto px-4">
    <div class="segmented card p-0 mb-4" style="box-shadow:none;">
      <button class="tab-btn active" data-tab="today">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="tab-btn" data-tab="summary">–ò—Ç–æ–≥–∏</button>
      <button class="tab-btn" data-tab="breath">–î—ã—Ö–∞–Ω–∏–µ</button>
      <button class="tab-btn" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <!-- TODAY -->
    <section id="tab-today">
      <div class="card p-4 mb-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-base font-semibold" style="letter-spacing:-0.02em;">–û—Ç–º–µ—Ç–∏—Ç—å –º–æ–º–µ–Ω—Ç</div>
            <div class="small-muted" id="todayMicrocopy">–û–¥–∏–Ω —à–∞–≥ ‚Äî —É–∂–µ –¥–≤–∏–∂–µ–Ω–∏–µ.</div>
          </div>
        </div>
      </div>

      <div class="grid gap-3 mb-3">
        <button id="btnGood" class="action-btn action-primary">–°–¥–µ–ª–∞–ª–∞ –ø–æ–ª–µ–∑–Ω–æ–µ</button>
        <button id="btnPause" class="action-btn action-neutral">–°–¥–µ–ª–∞–ª–∞ –ø–∞—É–∑—É</button>
      </div>

      <button id="btnArea" class="ghost-btn w-full mb-4" style="border-radius:18px; padding:12px 12px;">
        ‚úçÔ∏è –•–æ—á–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ –æ—Ç–º–µ—Ç–∏—Ç—å, –ø—Ä–æ —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ?
      </button>

      <div class="card p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">–°–µ–≥–æ–¥–Ω—è</div>
          <button id="btnClearToday" class="ghost-btn" style="padding:8px 10px; font-size:13px; border-radius:14px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="todayDots" class="dot-row"></div>
        <div id="todayEmpty" class="small-muted mt-2" style="display:none;">
          –ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ ‚Äî –∏ —ç—Ç–æ —Ç–æ–∂–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
        </div>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="tab-summary" class="hidden">
      <div class="card p-4 mb-4">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-base font-semibold" style="letter-spacing:-0.02em;">–ò—Ç–æ–≥–∏ –¥–Ω—è</div>
            <div class="small-muted" id="summaryDate"></div>
          </div>
        </div>

        <div class="flex items-center gap-2 mb-2">
          <span class="pill" id="pillGood">–ü–æ–ª–µ–∑–Ω–æ–µ: 0</span>
          <span class="pill" id="pillPause">–ü–∞—É–∑–∞: 0</span>
        </div>

        <div class="legend">
          <span>üü¶ ‚Äî –≤ –ø–æ–ª–µ–∑–Ω–æ–º</span>
          <span>‚óªÔ∏è ‚Äî –≤ –ø–∞—É–∑–µ</span>
        </div>

        <div id="summaryDots" class="dot-row mb-3"></div>

        <div id="surpriseBox" class="surprise" style="display:none;"></div>

        <div class="mt-3 small-muted whitespace-pre-wrap" id="dailyText"></div>

        <!-- ‚úÖ –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: –≤–∏–∑—É–∞–ª—å–Ω—ã–π –±–ª–æ–∫ -->
        <div id="dailyAreasWrap" class="areas-wrap" style="display:none;">
          <div class="areas-title">–û–±–ª–∞—Å—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è</div>
          <div id="dailyAreas"></div>
        </div>
      </div>

      <div class="card p-4">
        <div class="text-base font-semibold mb-1" style="letter-spacing:-0.02em;">–ù–µ–¥–µ–ª—è</div>
        <div class="small-muted mb-2">–°–µ–º—å –¥–Ω–µ–π ‚Äî –æ–¥–Ω–∞ –ª–∏–Ω–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏–π.</div>

        <div class="legend">
          <span>üü¶ ‚Äî –≤ –ø–æ–ª–µ–∑–Ω–æ–º</span>
          <span>‚óªÔ∏è ‚Äî –≤ –ø–∞—É–∑–µ</span>
        </div>

        <div id="weekGrid" class="grid gap-2 mt-3"></div>

        <div class="mt-3 small-muted whitespace-pre-wrap" id="weeklyText"></div>

        <div id="weeklyAreasWrap" class="areas-wrap" style="display:none;">
          <div class="areas-title">–û–±–ª–∞—Å—Ç–∏ –∑–∞ 7 –¥–Ω–µ–π</div>
          <div id="weeklyAreas"></div>
        </div>
      </div>
    </section>

    <!-- BREATH -->
    <section id="tab-breath" class="hidden">
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-base font-semibold" style="letter-spacing:-0.02em;">1 –º–∏–Ω—É—Ç–∞</div>
            <div class="small-muted">–î—ã—Ö–∞–Ω–∏–µ 4 ‚Ä¢ 4 ‚Ä¢ 4 ‚Ä¢ 4</div>
          </div>
          <button id="breathToggle" class="ghost-btn">–ù–∞—á–∞—Ç—å</button>
        </div>

        <div class="breath-wrap">
          <div class="breath-shadow">
            <div id="breathCircle" class="breath-circle" aria-label="–¥—ã—Ö–∞–Ω–∏–µ">
              <span id="breathLabel">–ì–æ—Ç–æ–≤–æ</span>
            </div>
          </div>
          <div class="breath-sub" id="breathSub">–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª –∏ –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É–π —Å—á—ë—Ç—É.</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="hidden">
      <div class="card p-4 mb-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">–¢–µ–º–∞</div>
        <div class="segmented" style="box-shadow:none;">
          <button class="tab-btn" data-theme="light" id="themeLight">‚òÄÔ∏é –°–≤–µ—Ç–ª–∞—è</button>
          <button class="tab-btn" data-theme="dark" id="themeDark">‚òæ –¢—ë–º–Ω–∞—è</button>
          <button class="tab-btn" data-theme="system" id="themeSystem">‚óØ –°–∏—Å—Ç–µ–º–Ω–∞—è</button>
        </div>
        <div class="small-muted mt-2">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å ¬´–°–∏—Å—Ç–µ–º–Ω–∞—è¬ª ‚Äî –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è.</div>
      </div>

      <div class="card p-4 mb-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
        <div class="small-muted whitespace-pre-wrap">
–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏–π.
–í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è —Ç—ã –æ—Ç–º–µ—á–∞–µ—à—å –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏: ¬´–ø–æ–ª–µ–∑–Ω–æ–µ¬ª –∏–ª–∏ ¬´–ø–∞—É–∑–∞¬ª.
–ö –∫–æ–Ω—Ü—É –¥–Ω—è —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–∏–Ω–∞, –∞ –ø–æ—Ç–æ–º ‚Äî –Ω–µ–¥–µ–ª—è.
–ò–∑ —Ç–∞–∫–∏—Ö –æ—Ç–º–µ—Ç–æ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–æ—â–µ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –≤–µ–¥—ë—Ç –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º ‚Äî –º—è–≥–∫–æ, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è.
        </div>
      </div>

      <div class="card p-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">–î–∞–Ω–Ω—ã–µ</div>
        <div class="small-muted">–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ ‚Äî –º–æ–∂–Ω–æ —Å—Ç–µ—Ä–µ—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é.</div>
        <div class="mt-3 flex gap-2">
          <button id="btnExport" class="ghost-btn flex-1">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <button id="btnReset" class="ghost-btn flex-1" style="border-color: rgba(37,99,235,0.25);">–°—Ç–µ—Ä–µ—Ç—å</button>
        </div>
        <pre id="exportBox" class="mt-3 hidden export-box small-muted whitespace-pre-wrap"></pre>
      </div>
    </section>
  </div>

  <!-- Event modal -->
  <div id="eventModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="–≤—ã–±–æ—Ä —Å–æ–±—ã—Ç–∏—è">
    <div class="card modal-card">
      <div class="text-base font-semibold" style="letter-spacing:-0.02em;">–ö–∞–∫–æ–π –º–æ–º–µ–Ω—Ç –æ—Ç–º–µ—Ç–∏—Ç—å?</div>
      <div class="small-muted mt-1">–í—ã–±–µ—Ä–∏ —Å–æ–±—ã—Ç–∏–µ –∏–∑ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ª—é–±–æ–µ.</div>

      <div id="eventList" class="grid gap-2 mt-3"></div>

      <div class="mt-3 flex justify-end gap-2">
        <button id="eventClose" class="ghost-btn" style="padding:10px 12px;">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Area modal -->
  <div id="areaModal" class="modal-overlay" role="dialog" aria-modal="true" aria-label="–æ–±–ª–∞—Å—Ç–∏">
    <div class="card modal-card">
      <div class="text-base font-semibold" style="letter-spacing:-0.02em;">–ü—Ä–æ —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ?</div>

      <div class="mt-2">
        <span id="areaContext" class="pill">–í—ã–±—Ä–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç: ‚Äî</span>
      </div>

      <div class="small-muted mt-2">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.</div>

      <div class="grid gap-2 mt-3">
        <button class="ghost-btn" data-area="mind">üß† –ú—ã—Å–ª–∏ / —ç–º–æ—Ü–∏–∏</button>
        <button class="ghost-btn" data-area="body">üçΩ –¢–µ–ª–æ / –µ–¥–∞</button>
        <button class="ghost-btn" data-area="energy">üõå –≠–Ω–µ—Ä–≥–∏—è / —É—Å—Ç–∞–ª–æ—Å—Ç—å</button>
        <button class="ghost-btn" data-area="relations">ü§ç –û—Ç–Ω–æ—à–µ–Ω–∏—è / –≥—Ä–∞–Ω–∏—Ü—ã</button>
        <button class="ghost-btn" data-area="skip">‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="mt-3 flex justify-end">
        <button id="areaClose" class="ghost-btn" style="padding:10px 12px;">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <div class="inner" id="toastInner">‚úì –ó–∞–ø–∏—Å–∞–Ω–æ</div>
  </div>

  <script>
    ;(() => {
      const tg = window.Telegram?.WebApp || null;
      try{ tg?.ready?.(); tg?.expand?.(); }catch(e){}

      const STORAGE = "balancecare_v15";
      const defaultState = () => ({
        theme: "system",
        events: [],
        surprise: { lastShownAt: null },
        ui: {
          microcopyDate: null,
          microcopyText: null,
          tagTargetIndex: null
        }
      });

      let state = loadState();

      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE);
          if(!raw) return defaultState();
          const parsed = JSON.parse(raw);
          return {
            ...defaultState(),
            ...parsed,
            ui: { ...defaultState().ui, ...(parsed.ui||{}) },
            surprise: { ...defaultState().surprise, ...(parsed.surprise||{}) },
            events: Array.isArray(parsed.events) ? parsed.events.map(e => ({
              ts: e.ts,
              date: e.date,
              type: e.type,
              area: (e.area ?? null),
            })) : []
          };
        }catch(e){ return defaultState(); }
      }
      function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }

      function pad(n){ return String(n).padStart(2,"0"); }
      function dateKey(d=new Date()){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
      function nowISO(){ return new Date().toISOString(); }

      function isLight(hex){
        try{
          const h = hex.replace("#","").trim();
          const full = h.length === 3 ? h.split("").map(x=>x+x).join("") : h;
          const n = parseInt(full,16);
          const r=(n>>16)&255, g=(n>>8)&255, b=n&255;
          const lum = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
          return lum > 0.6;
        }catch(e){ return true; }
      }

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      function toast(msg){
        const t = $("#toast");
        $("#toastInner").textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._t);
        toast._t = setTimeout(() => t.classList.remove("show"), 1400);
      }
      function haptic(kind="light"){
        try{
          if(tg?.HapticFeedback){
            if(kind==="success") tg.HapticFeedback.notificationOccurred("success");
            else tg.HapticFeedback.impactOccurred("light");
          }
        }catch(e){}
      }
      function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

      let systemListenerAttached = false;

      function renderThemeButtons(){
        const map = { light:"themeLight", dark:"themeDark", system:"themeSystem" };
        ["themeLight","themeDark","themeSystem"].forEach(id => {
          const el = document.getElementById(id);
          el.classList.remove("active");
          el.style.background = "transparent";
          el.style.color = "var(--muted)";
        });
        const activeId = map[state.theme] || "themeSystem";
        const activeEl = document.getElementById(activeId);
        activeEl.classList.add("active");
        activeEl.style.background = "linear-gradient(180deg, var(--primary), var(--primary2))";
        activeEl.style.color = "white";
      }

      function applyTheme(){
        if(state.theme === "light"){
          document.documentElement.setAttribute("data-theme","light");
        }else if(state.theme === "dark"){
          document.documentElement.setAttribute("data-theme","dark");
        }else{
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          document.documentElement.setAttribute("data-theme", prefersDark ? "dark" : "light");
          if(!systemListenerAttached && window.matchMedia){
            systemListenerAttached = true;
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
              if(state.theme === "system") applyTheme();
            });
          }
        }

        try{
          const tp = tg?.themeParams || {};
          const bg = tp.bg_color;
          if(state.theme === "system" && bg){
            document.documentElement.setAttribute("data-theme", isLight(bg) ? "light" : "dark");
          }
        }catch(e){}

        renderThemeButtons();
      }

      const MICRO_SHORT = [
        "–û–¥–∏–Ω —à–∞–≥ ‚Äî —É–∂–µ –¥–≤–∏–∂–µ–Ω–∏–µ.",
        "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –ø–æ-–¥–æ–±—Ä–æ–º—É –∫ —Å–µ–±–µ.",
        "–ó–∞–º–µ—á–∞—Ç—å ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –Ω–∞–≤—ã–∫.",
        "–ß—É—Ç—å —è—Å–Ω–µ–µ ‚Äî —É–∂–µ –ª–µ–≥—á–µ.",
        "–ú–∞–ª–µ–Ω—å–∫–æ–µ —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è.",
        "–ü–∞—É–∑–∞ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ–≤–∞–ª, –∞ –≤–æ–∑–¥—É—Ö.",
        "–ù–∏–∫–∞–∫–æ–π –≥–æ–Ω–∫–∏. –ü—Ä–æ—Å—Ç–æ –¥–µ–Ω—å.",
        "–°–¥–µ–ª–∞–ª–∞ ‚Äî –æ—Ç–º–µ—Ç–∏–ª–∞ ‚Äî –æ—Ç–ø—É—Å—Ç–∏–ª–∞.",
        "–ß–µ—Å—Ç–Ω–æ—Å—Ç—å —Å —Å–æ–±–æ–π ‚Äî —ç—Ç–æ —Å–∏–ª–∞.",
        "–ú–æ–∂–Ω–æ –º—è–≥–∫–æ –∏ –≤—Å—ë –µ—â—ë —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.",
        "–°–µ–π—á–∞—Å –≤–∞–∂–Ω–µ–µ –±–µ—Ä–µ–∂–Ω–æ—Å—Ç—å, —á–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å.",
        "–ù–µ–º–Ω–æ–≥–æ —Ç–∏—à–µ –≤ –≥–æ–ª–æ–≤–µ ‚Äî —É–∂–µ –ø–æ–±–µ–¥–∞."
      ];

      const MICRO_LONG = [
        "–ù–µ –Ω—É–∂–Ω–æ ¬´–ø—Ä–∞–≤–∏–ª—å–Ω–æ¬ª.\n–ù—É–∂–Ω–æ —Ç–∞–∫, —á—Ç–æ–±—ã —Ç–µ–±–µ –±—ã–ª–æ —É—Å—Ç–æ–π—á–∏–≤–æ.",
        "–¢—ã –æ—Ç–º–µ—á–∞–µ—à—å –Ω–µ –æ—Ü–µ–Ω–∫–∏, –∞ —Ñ–∞–∫—Ç—ã.\n–ò –æ—Ç —ç—Ç–æ–≥–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ø–æ–∫–æ–π–Ω–µ–µ.",
        "–î–µ–Ω—å –Ω–µ –æ–±—è–∑–∞–Ω –±—ã—Ç—å —Ä–æ–≤–Ω—ã–º.\n–í–∞–∂–Ω–æ, —á—Ç–æ —Ç—ã –æ—Å—Ç–∞—ë—à—å—Å—è –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å —Å–æ–±–æ–π.",
        "–ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ ‚Äî –æ–∫–µ–π.\n–ú—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–∏–Ω—É, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è.",
        "–ü–∞—É–∑–∞ ‚Äî —ç—Ç–æ –Ω–µ ¬´—Å–¥–∞–ª–∞—Å—å¬ª.\n–≠—Ç–æ ¬´—è –∑–∞–º–µ—Ç–∏–ª–∞ –∏ –≤—ã–±—Ä–∞–ª–∞ –Ω–µ –ª–æ–º–∞—Ç—å —Å–µ–±—è¬ª.",
        "–° –∫–∞–∂–¥—ã–º –Ω–∞–∂–∞—Ç–∏–µ–º —Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å —Å–µ–±–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.\n–°–ø–æ–∫–æ–π–Ω–æ, –±–µ–∑ ¬´–¥–æ–ª–∂–Ω–∞¬ª.",
        "–í–∞–∂–µ–Ω –Ω–µ –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å.\n–í–∞–∂–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∑–∞–º–µ—Ç–∏—Ç—å –º–æ–º–µ–Ω—Ç –∏ –≤—ã–±—Ä–∞—Ç—å –¥–∞–ª—å—à–µ."
      ];

      function pickQuote(){
        const useLong = Math.random() < 0.55;
        return useLong ? pick(MICRO_LONG) : pick(MICRO_SHORT);
      }
      function ensureMicrocopyForToday(){
        const d = dateKey();
        if(state.ui.microcopyDate !== d || !state.ui.microcopyText){
          state.ui.microcopyDate = d;
          state.ui.microcopyText = pickQuote();
          save();
        }
        $("#todayMicrocopy").textContent = state.ui.microcopyText;
      }

      let currentTab = "today";
      function setTab(name){
        currentTab = name;
        $$(".tab-btn[data-tab]").forEach(btn => btn.classList.toggle("active", btn.dataset.tab === name));
        ["today","summary","breath","settings"].forEach(t => $("#tab-"+t).classList.toggle("hidden", t !== name));

        if(name === "today") ensureMicrocopyForToday();
        if(name === "summary") renderSummary();
        if(name !== "breath") stopBreathing(false);
      }
      $$(".tab-btn[data-tab]").forEach(btn => btn.addEventListener("click", () => setTab(btn.dataset.tab)));

      function eventsFor(d){ return state.events.filter(e => e.date === d); }
      function countFor(d){
        const ev = eventsFor(d);
        const good = ev.filter(x => x.type === "good").length;
        const pause = ev.filter(x => x.type === "pause").length;
        return { good, pause, total: ev.length, ev };
      }
      function renderDots(container, ev){
        container.innerHTML = "";
        ev.slice(-48).forEach(e => {
          const dot = document.createElement("div");
          dot.className = "dot " + (e.type === "good" ? "good" : "pause");
          container.appendChild(dot);
        });
      }

      function renderToday(){
        const d = dateKey();
        const { ev, total } = countFor(d);
        const row = $("#todayDots");
        const empty = $("#todayEmpty");
        if(total === 0){
          row.innerHTML = "";
          empty.style.display = "block";
        }else{
          empty.style.display = "none";
          renderDots(row, ev);
        }
      }

      function addEvent(type){
        state.events.push({ ts: nowISO(), date: dateKey(), type, area: null });
        save();
        renderToday();
        if(currentTab === "summary") renderSummary();
        toast("‚úì –ó–∞–ø–∏—Å–∞–Ω–æ");
        haptic("success");
      }

      function clearToday(){
        const d = dateKey();
        state.events = state.events.filter(e => e.date !== d);
        save();
        renderToday();
        if(currentTab === "summary") renderSummary();
        toast("–û—á–∏—â–µ–Ω–æ");
        haptic("light");
      }

      const AREA_LABEL = {
        mind: "üß† –ú—ã—Å–ª–∏ / —ç–º–æ—Ü–∏–∏",
        body: "üçΩ –¢–µ–ª–æ / –µ–¥–∞",
        energy: "üõå –≠–Ω–µ—Ä–≥–∏—è / —É—Å—Ç–∞–ª–æ—Å—Ç—å",
        relations: "ü§ç –û—Ç–Ω–æ—à–µ–Ω–∏—è / –≥—Ä–∞–Ω–∏—Ü—ã"
      };

      function closeEventModal(){ $("#eventModal").classList.remove("show"); }
      function openEventModal(){ $("#eventModal").classList.add("show"); }
      function closeAreaModal(){ $("#areaModal").classList.remove("show"); }
      function openAreaModal(){ $("#areaModal").classList.add("show"); }

      function fmtTime(iso){
        try{
          const d = new Date(iso);
          return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }catch(e){ return ""; }
      }

      function listTodayIndices(limit=12){
        const d = dateKey();
        const idx = [];
        for(let i = state.events.length - 1; i >= 0; i--){
          if(state.events[i].date === d){
            idx.push(i);
            if(idx.length >= limit) break;
          }
        }
        return idx;
      }

      function setAreaContextPill(idx){
        const el = $("#areaContext");
        if(idx === null || idx === undefined || idx < 0 || idx >= state.events.length){
          el.className = "pill";
          el.textContent = "–í—ã–±—Ä–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç: ‚Äî";
          return;
        }
        const e = state.events[idx];
        const t = fmtTime(e.ts);
        const isGood = e.type === "good";
        el.className = "pill " + (isGood ? "pill-good" : "pill-pause");
        el.textContent = (isGood ? "üü¶ –ü–æ–ª–µ–∑–Ω–æ–µ" : "‚óªÔ∏è –ü–∞—É–∑–∞") + (t ? (" ‚Ä¢ " + t) : "");
      }

      function renderEventPicker(){
        const list = $("#eventList");
        list.innerHTML = "";
        const indices = listTodayIndices(12);

        if(indices.length === 0){
          const t = document.createElement("div");
          t.className = "small-muted";
          t.textContent = "–°–Ω–∞—á–∞–ª–∞ –æ—Ç–º–µ—Ç—å –º–æ–º–µ–Ω—Ç –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã—à–µ üôÇ";
          list.appendChild(t);
          return;
        }

        indices.forEach(i=>{
          const e = state.events[i];
          const btn = document.createElement("button");
          btn.className = "event-row " + (e.type === "good" ? "good-bg" : "pause-bg");

          const badge = document.createElement("span");
          badge.className = "event-badge " + (e.type === "good" ? "good" : "pause");

          const title = document.createElement("div");
          title.className = "event-title";
          title.textContent = e.type === "good" ? "–ü–æ–ª–µ–∑–Ω–æ–µ" : "–ü–∞—É–∑–∞";

          const sub = document.createElement("div");
          sub.className = "event-sub";
          sub.textContent = e.area ? `–û–±–ª–∞—Å—Ç—å: ${AREA_LABEL[e.area] || e.area}` : "–û–±–ª–∞—Å—Ç—å: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞";

          const left = document.createElement("div");
          left.className = "event-left";
          const textWrap = document.createElement("div");
          textWrap.style.minWidth = "0";
          textWrap.appendChild(title);
          textWrap.appendChild(sub);
          left.appendChild(badge);
          left.appendChild(textWrap);

          const right = document.createElement("div");
          right.className = "event-right";
          right.textContent = fmtTime(e.ts);

          btn.appendChild(left);
          btn.appendChild(right);

          btn.addEventListener("click", () => {
            state.ui.tagTargetIndex = i;
            save();
            closeEventModal();
            setAreaContextPill(i);
            openAreaModal();
          });

          list.appendChild(btn);
        });
      }

      function onTagClick(){
        renderEventPicker();
        openEventModal();
      }

      function setArea(areaKeyOrSkip){
        const idx = state.ui.tagTargetIndex;

        if(idx === null || idx === undefined || idx < 0 || idx >= state.events.length){
          renderEventPicker();
          closeAreaModal();
          openEventModal();
          toast("–í—ã–±–µ—Ä–∏ —Å–æ–±—ã—Ç–∏–µ");
          haptic("light");
          return;
        }

        if(areaKeyOrSkip === "skip"){
          closeAreaModal();
          toast("–û–∫, –±–µ–∑ –æ–±–ª–∞—Å—Ç–∏");
          haptic("light");
          return;
        }

        state.events[idx].area = areaKeyOrSkip;
        save();
        closeAreaModal();
        toast("‚úì –û—Ç–º–µ—á–µ–Ω–æ");
        haptic("success");
        if(currentTab === "summary") renderSummary();
      }

      function areasSplitForDate(d){
        const ev = eventsFor(d);
        const good = { mind:0, body:0, energy:0, relations:0 };
        const pause = { mind:0, body:0, energy:0, relations:0 };
        let total = 0;
        ev.forEach(e=>{
          const a = e.area;
          if(a && (a in good)){
            if(e.type === "good") good[a] += 1;
            else pause[a] += 1;
            total += 1;
          }
        });
        return { good, pause, total };
      }

      // ‚úÖ –º–∏–Ω–∏-–ø–æ–ª–æ—Å–∫–∏: maxSquares ‚Äî —Å–∫–æ–ª—å–∫–æ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–≤ –≤ —Ä—è–¥
      function renderMiniBar(count, maxSquares, type){
        const wrap = document.createElement("div");
        wrap.className = "mini-bar";
        const filled = Math.min(count, maxSquares);

        for(let i=0;i<maxSquares;i++){
          const sq = document.createElement("span");
          sq.className = "sq " + (i < filled ? type : "empty");
          wrap.appendChild(sq);
        }
        return wrap;
      }

      function renderAreasVisual(containerEl, goodCounts, pauseCounts){
        containerEl.innerHTML = "";

        const keys = ["mind","body","energy","relations"];
        const totals = keys.map(k => (goodCounts[k]||0) + (pauseCounts[k]||0));
        const maxTotal = Math.max(0, ...totals);

        // –¥–∏–Ω–∞–º–∏–∫–∞: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—å—à–µ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–≤, –µ—Å–ª–∏ –º–Ω–æ–≥–æ ‚Äî –±–æ–ª—å—à–µ
        const maxSquares = maxTotal <= 4 ? 4 : (maxTotal <= 8 ? 8 : 10);

        keys.forEach(k=>{
          const g = goodCounts[k] || 0;
          const p = pauseCounts[k] || 0;
          if(g + p === 0) return;

          const row = document.createElement("div");
          row.className = "area-row";

          const label = document.createElement("div");
          label.className = "area-label";
          label.textContent = AREA_LABEL[k];

          const bars = document.createElement("div");
          bars.className = "bars";

          // line 1: good
          const line1 = document.createElement("div");
          line1.className = "barline";
          const badge1 = document.createElement("div");
          badge1.className = "barbadge";
          badge1.textContent = `üü¶ ${g}`;
          line1.appendChild(badge1);
          line1.appendChild(renderMiniBar(g, maxSquares, "good"));

          // line 2: pause
          const line2 = document.createElement("div");
          line2.className = "barline";
          const badge2 = document.createElement("div");
          badge2.className = "barbadge";
          badge2.textContent = `‚óªÔ∏è ${p}`;
          line2.appendChild(badge2);
          line2.appendChild(renderMiniBar(p, maxSquares, "pause"));

          bars.appendChild(line1);
          bars.appendChild(line2);

          row.appendChild(label);
          row.appendChild(bars);
          containerEl.appendChild(row);
        });
      }

      const SURPRISE_LINES = [
        "–¢—ã –∫–ª–∞—Å—Å–Ω–æ —ç—Ç–æ –≤–µ–¥—ë—à—å: –ø—Ä–æ—Å—Ç–æ, —á–µ—Å—Ç–Ω–æ, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è.",
        "–í–∏–¥–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ. –î–∞–∂–µ –∫–æ–≥–¥–∞ –æ–Ω–æ –º–∞–ª–µ–Ω—å–∫–æ–µ ‚Äî –æ–Ω–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ.",
        "–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è, —á—Ç–æ —Ç—ã –≤—ã–±–∏—Ä–∞–µ—à—å —è—Å–Ω–æ—Å—Ç—å –≤–º–µ—Å—Ç–æ —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∏.",
        "–¢–≤–æ—è ¬´–ø–∞—É–∑–∞¬ª ‚Äî —ç—Ç–æ —É–º–µ–Ω–∏–µ —Å–µ–±—è –Ω–µ –ª–æ–º–∞—Ç—å. –≠—Ç–æ —Ü–µ–Ω–Ω–æ.",
        "–°–µ–≥–æ–¥–Ω—è —Ç—ã –∑–∞–º–µ—Ç–∏–ª–∞ –∏ –æ—Ç–º–µ—Ç–∏–ª–∞ ‚Äî –∏ —ç—Ç–æ —É–∂–µ –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ."
      ];
      function shouldShowSurprise(){
        const last = state.surprise?.lastShownAt ? new Date(state.surprise.lastShownAt).getTime() : 0;
        const sixHours = 6 * 60 * 60 * 1000;
        return (Date.now() - last) > sixHours && Math.random() < 0.35;
      }

      function dailySummaryText(){
        const d = dateKey();
        const { good, pause, total } = countFor(d);

        if(total === 0) return "–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Ç–∏—Ö–æ ‚Äî –±–µ–∑ –æ—Ç–º–µ—Ç–æ–∫.\n–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å, –≤–µ—Ä–Ω—ë—à—å—Å—è –ø–æ–∑–∂–µ.";
        if(good > 0 && pause === 0) return "–°–µ–≥–æ–¥–Ω—è —Ç—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã–±—Ä–∞–ª–∞ –ø–æ–ª–µ–∑–Ω–æ–µ.\n–ü—É—Å—Ç—å —ç—Ç–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∫ —Ç—ë–ø–ª–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: —Ç—ã –º–æ–∂–µ—à—å.";
        if(pause > 0 && good === 0) return "–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ –±–æ–ª—å—à–µ –ø–∞—É–∑.\n–≠—Ç–æ –Ω–µ –ø—Ä–æ ¬´–ø–ª–æ—Ö–æ¬ª. –≠—Ç–æ –ø—Ä–æ —Ä–µ—Å—É—Ä—Å: —Ç—ã –∑–∞–º–µ—Ç–∏–ª–∞, –≥–¥–µ –Ω—É–∂–µ–Ω –≤–æ–∑–¥—É—Ö.";
        if(good >= pause) return "–î–µ–Ω—å –ø–æ–ª—É—á–∏–ª—Å—è —Ä–∞–∑–Ω—ã–º ‚Äî –∏ –≤ —ç—Ç–æ–º –µ—Å—Ç—å –∂–∏–∑–Ω—å.\n–¢—ã –¥–µ–ª–∞–µ—à—å –≥–ª–∞–≤–Ω–æ–µ: –∑–∞–º–µ—á–∞–µ—à—å –∏ –Ω–µ –¥–∞–≤–∏—à—å –Ω–∞ —Å–µ–±—è.";
        return "–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ –Ω–µ–ø—Ä–æ—Å—Ç–æ, –Ω–æ —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Å—Ç–∞–ª–∞—Å—å —Å —Å–æ–±–æ–π –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ.\n–≠—Ç–æ —Å–∏–ª—å–Ω–∞—è –æ–ø–æ—Ä–∞.";
      }

      function lastNDays(n){
        const out = [];
        const base = new Date();
        for(let i=0;i<n;i++){
          const d = new Date(base);
          d.setDate(base.getDate()-i);
          out.push(dateKey(d));
        }
        return out.reverse();
      }
      function dayName(iso){
        const d = new Date(iso+"T00:00:00");
        const map = ["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"];
        return map[d.getDay()];
      }
      function weeklySummaryText(){
        const days = lastNDays(7);
        let g=0,p=0;
        days.forEach(d=>{
          const c=countFor(d);
          g+=c.good; p+=c.pause;
        });
        if(g+p===0) return "–ù–µ–¥–µ–ª—è –±—ã–ª–∞ –æ—á–µ–Ω—å —Ç–∏—Ö–æ–π.\n–ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ —É—Å—Ç–∞–ª–æ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –º–∞–ª–æ–≥–æ: –æ–¥–Ω–æ–π –æ—Ç–º–µ—Ç–∫–∏ –∏–ª–∏ –æ–¥–Ω–æ–π –º–∏–Ω—É—Ç—ã –¥—ã—Ö–∞–Ω–∏—è.";
        const line = g>=p
          ? "–í –Ω–µ–¥–µ–ª–µ –±—ã–ª–æ –º–µ—Å—Ç–æ –∏ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è, –∏ –¥–ª—è –ø–∞—É–∑. –≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∂–∏–≤–æ–π –±–∞–ª–∞–Ω—Å."
          : "–í –Ω–µ–¥–µ–ª–µ –±—ã–ª–æ –±–æ–ª—å—à–µ –ø–∞—É–∑. –í–æ–∑–º–æ–∂–Ω–æ, —Ç–µ–±–µ —Å–µ–π—á–∞—Å –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –±–µ—Ä–µ—á—å —Ä–µ—Å—É—Ä—Å ‚Äî –∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.";
        return `–ü–æ–ª–µ–∑–Ω–æ–µ: ${g}\n–ü–∞—É–∑–∞: ${p}\n\n${line}`;
      }

      function renderSummary(){
        $("#summaryDate").textContent = new Date().toLocaleDateString("ru-RU", { weekday:"long", day:"numeric", month:"long" });

        const d = dateKey();
        const c = countFor(d);
        $("#pillGood").textContent = `–ü–æ–ª–µ–∑–Ω–æ–µ: ${c.good}`;
        $("#pillPause").textContent = `–ü–∞—É–∑–∞: ${c.pause}`;

        const row = $("#summaryDots");
        if(c.total===0) row.innerHTML = ""; else renderDots(row, c.ev);

        const box = $("#surpriseBox");
        if(shouldShowSurprise()){
          box.style.display = "block";
          box.textContent = pick(SURPRISE_LINES);
          state.surprise.lastShownAt = nowISO();
          save();
        }else{
          box.style.display = "none";
        }

        $("#dailyText").textContent = dailySummaryText();

        // ‚úÖ Day areas visual
        const daySplit = areasSplitForDate(d);
        const dailyWrap = $("#dailyAreasWrap");
        if(daySplit.total){
          dailyWrap.style.display = "block";
          renderAreasVisual($("#dailyAreas"), daySplit.good, daySplit.pause);
        }else{
          dailyWrap.style.display = "none";
          $("#dailyAreas").innerHTML = "";
        }

        // Week grid
        const grid = $("#weekGrid");
        grid.innerHTML = "";
        lastNDays(7).forEach(dd=>{
          const cc = countFor(dd);
          const item = document.createElement("div");
          item.className = "p-3";
          item.style.border = "1px solid var(--stroke)";
          item.style.borderRadius = "16px";
          item.style.background = (document.documentElement.getAttribute("data-theme")==="dark")
            ? "rgba(255,255,255,0.06)"
            : "rgba(255,255,255,0.55)";

          const header = document.createElement("div");
          header.className = "flex items-center justify-between mb-2";
          header.innerHTML = `<div style="font-weight:650; letter-spacing:-0.02em;">${dayName(dd)}</div><div class="small-muted">${cc.good}/${cc.pause}</div>`;

          const dots = document.createElement("div");
          dots.className = "dot-row";
          if(cc.total>0){
            cc.ev.slice(-24).forEach(e=>{
              const dot = document.createElement("div");
              dot.className = "dot " + (e.type==="good" ? "good" : "pause");
              dots.appendChild(dot);
            });
          }else{
            const t=document.createElement("div");
            t.className="small-muted";
            t.textContent="‚Äî";
            dots.appendChild(t);
          }

          item.appendChild(header);
          item.appendChild(dots);
          grid.appendChild(item);
        });

        $("#weeklyText").textContent = weeklySummaryText();

        // ‚úÖ Week areas visual
        const days = lastNDays(7);
        const weekGood = { mind:0, body:0, energy:0, relations:0 };
        const weekPause = { mind:0, body:0, energy:0, relations:0 };
        let weekTotal = 0;

        days.forEach(dd=>{
          const split = areasSplitForDate(dd);
          Object.keys(weekGood).forEach(k=>{
            weekGood[k] += split.good[k];
            weekPause[k] += split.pause[k];
          });
          weekTotal += split.total;
        });

        const weeklyWrap = $("#weeklyAreasWrap");
        if(weekTotal){
          weeklyWrap.style.display = "block";
          renderAreasVisual($("#weeklyAreas"), weekGood, weekPause);
        }else{
          weeklyWrap.style.display = "none";
          $("#weeklyAreas").innerHTML = "";
        }
      }

      // =========================
      // BREATHING 4‚Äì4‚Äì4‚Äì4
      // =========================
      const breathCircle = $("#breathCircle");
      const breathLabel  = $("#breathLabel");
      const breathSub    = $("#breathSub");
      const breathToggle = $("#breathToggle");

      let breathTimer = null;
      let breathElapsed = 0;
      let phaseIndex = 0;
      let secondInPhase = 0;
      let running = false;

      const PHASES = [
        { label:"–í–¥–æ—Ö",  dur:4, from:0.78, to:1.00 },
        { label:"–ü–∞—É–∑–∞", dur:4, from:1.00, to:1.00 },
        { label:"–í—ã–¥–æ—Ö", dur:4, from:1.00, to:0.78 },
        { label:"–ü–∞—É–∑–∞", dur:4, from:0.78, to:0.78 }
      ];

      function setScale(scale, smooth=true, seconds=1){
        breathCircle.style.transition = smooth ? `transform ${seconds}s linear` : "none";
        breathCircle.style.transform = `translateZ(0) scale(${scale})`;
      }

      function countString(n){
        const base = ["1","2","3","4"];
        return base.slice(0, Math.max(1, Math.min(4,n))).join("-");
      }

      function runPhase(i){
        const phase = PHASES[i];
        phaseIndex = i;
        secondInPhase = 0;

        breathLabel.textContent = phase.label;
        breathSub.textContent = `${phase.label} ${countString(1)}`;

        setScale(phase.from, false);

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            setScale(phase.to, true, phase.dur);
          });
        });
      }

      function startBreathing(){
        stopBreathing(false);

        running = true;
        breathElapsed = 0;
        breathToggle.textContent = "–°—Ç–æ–ø";

        runPhase(0);

        breathTimer = setInterval(() => {
          breathElapsed++;

          const phase = PHASES[phaseIndex];

          secondInPhase++;
          if(secondInPhase < phase.dur){
            breathSub.textContent = `${phase.label} ${countString(secondInPhase+1)}`;
          }else{
            const next = (phaseIndex + 1) % PHASES.length;
            runPhase(next);
          }

          if(breathElapsed >= 60){
            stopBreathing(true);
          }
        }, 1000);
      }

      function stopBreathing(auto){
        if(breathTimer){
          clearInterval(breathTimer);
          breathTimer = null;
        }
        running = false;

        breathToggle.textContent = "–ù–∞—á–∞—Ç—å";
        breathLabel.textContent = "–ì–æ—Ç–æ–≤–æ";
        breathSub.textContent = auto
          ? "–û—Ç–ª–∏—á–Ω–æ. –ü–∞—Ä—É —Å–µ–∫—É–Ω–¥ –ø—Ä–æ—Å—Ç–æ –ø–æ–±—É–¥—å –≤ —ç—Ç–æ–º –æ—â—É—â–µ–Ω–∏–∏."
          : "–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª –∏ –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É–π —Å—á—ë—Ç—É.";

        setScale(0.78, true, 0.6);

        if(auto){
          toast("‚úì 1 –º–∏–Ω—É—Ç–∞");
          haptic("success");
        }
      }

      breathToggle.addEventListener("click", () => running ? stopBreathing(false) : startBreathing());

      $("#btnGood").addEventListener("click", () => addEvent("good"));
      $("#btnPause").addEventListener("click", () => addEvent("pause"));
      $("#btnClearToday").addEventListener("click", clearToday);

      $("#btnArea").addEventListener("click", onTagClick);

      $("#eventClose").addEventListener("click", closeEventModal);
      $("#eventModal").addEventListener("click", (e) => {
        if(e.target && e.target.id === "eventModal") closeEventModal();
      });

      $("#areaClose").addEventListener("click", closeAreaModal);
      $("#areaModal").addEventListener("click", (e) => {
        if(e.target && e.target.id === "areaModal") closeAreaModal();
      });
      $$("#areaModal [data-area]").forEach(btn => {
        btn.addEventListener("click", () => setArea(btn.dataset.area));
      });

      $$("#tab-settings [data-theme]").forEach(btn=>{
        btn.addEventListener("click", () => {
          state.theme = btn.dataset.theme;
          save();
          applyTheme();
          toast("–¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
        });
      });

      $("#btnExport").addEventListener("click", () => {
        const box = $("#exportBox");
        box.classList.remove("hidden");
        box.textContent = JSON.stringify(state, null, 2);
        navigator.clipboard?.writeText(box.textContent).catch(()=>{});
        toast("–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
        haptic("success");
      });

      $("#btnReset").addEventListener("click", () => {
        const ok = confirm("–°—Ç–µ—Ä–µ—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ?");
        if(!ok) return;
        state = defaultState();
        save();
        $("#exportBox").classList.add("hidden");
        renderToday();
        ensureMicrocopyForToday();
        toast("–ì–æ—Ç–æ–≤–æ. –ß–∏—Å—Ç—ã–π –ª–∏—Å—Ç");
        haptic("light");
      });

      // init
      applyTheme();
      renderToday();
      ensureMicrocopyForToday();
      setAreaContextPill(null);
      setTab("today");
    })();
  </script>
</body>
</html>
