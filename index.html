<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Balance Care</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --bg: #f6f7fb;
      --card: rgba(255,255,255,0.92);
      --card2: rgba(255,255,255,0.78);
      --stroke: rgba(15,23,42,0.10);
      --text: rgba(15,23,42,0.92);
      --muted: rgba(15,23,42,0.62);

      --primary: #2563eb;
      --primary2:#1d4ed8;

      --neutralText: rgba(15,23,42,0.82);

      --shadow: 0 14px 40px rgba(15,23,42,0.10);
      --radius: 22px;

      --goodTint: rgba(37,99,235,0.10);
      --pauseTint: rgba(148,163,184,0.14);
      --goodBorder: rgba(37,99,235,0.24);
      --pauseBorder: rgba(148,163,184,0.28);

      --chipBg: rgba(255,255,255,0.55);
      --chipBgSoft: rgba(255,255,255,0.40);

      --flashBgStart: rgba(37,99,235,0.30);
      --flashBorderStart: rgba(37,99,235,0.45);
    }

    html[data-theme="dark"]{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);

      --neutralText: rgba(255,255,255,0.88);
      --shadow: 0 18px 50px rgba(0,0,0,0.35);

      --goodTint: rgba(37,99,235,0.20);
      --pauseTint: rgba(148,163,184,0.12);
      --goodBorder: rgba(37,99,235,0.34);
      --pauseBorder: rgba(148,163,184,0.26);

      --chipBg: rgba(255,255,255,0.06);
      --chipBgSoft: rgba(255,255,255,0.05);

      --flashBgStart: rgba(37,99,235,0.28);
      --flashBorderStart: rgba(37,99,235,0.42);
    }

    *{ -webkit-tap-highlight-color: transparent; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(37,99,235,0.10), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(29,78,216,0.10), transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    .app-wrap{
      padding-top: calc(14px + var(--safe-top));
      padding-bottom: calc(18px + var(--safe-bottom));
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .segmented{
      background: rgba(255,255,255,0.55);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 6px;
      display:flex;
      gap: 6px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    html[data-theme="dark"] .segmented{ background: rgba(255,255,255,0.06); }

    .tab-btn{
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
      border: 1px solid transparent;
      color: var(--muted);
      background: transparent;
      transition: transform .06s ease, background .18s ease, color .18s ease, border-color .18s ease;
      user-select: none;
      -webkit-user-select: none;
      flex: 0 0 auto;
    }
    .tab-btn:active{ transform: scale(0.99); }
    .tab-btn.active{
      color: white;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-color: rgba(255,255,255,0.18);
      box-shadow: 0 10px 26px rgba(37,99,235,0.22);
    }

    .action-btn{
      width: 100%;
      border-radius: 20px;
      padding: 18px 16px;
      font-size: 18px;
      font-weight: 650;
      border: 1px solid var(--stroke);
      transition: transform .06s ease, filter .08s ease;
      user-select: none;
      -webkit-user-select: none;
    }
    .action-btn:active{ transform: translateY(1px); filter: brightness(0.98); }

    .action-primary{
      color: white;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-color: rgba(255,255,255,0.18);
      box-shadow: 0 14px 34px rgba(37,99,235,0.26);
    }

    .action-neutral{
      color: var(--neutralText);
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.45));
    }
    html[data-theme="dark"] .action-neutral{
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
    }

    .dot-row{ display:flex; gap:12px; flex-wrap: wrap; padding-top: 10px; }

    .dot-wrap{
      position: relative;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      flex: 0 0 auto;
      user-select:none;
      -webkit-user-select:none;
    }
    .dot{
      width: 16px; height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 8px 20px rgba(15,23,42,0.06);
      transform-origin: center;
    }
    html[data-theme="dark"] .dot{
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 8px 20px rgba(0,0,0,0.22);
    }
    .dot.good{ background: var(--primary); }
    .dot.pause{ background: rgba(148,163,184,0.95); }
    html[data-theme="dark"] .dot.pause{ background: rgba(203,213,225,0.55); }

    .dot-wrap.delete-mode .dot{
      outline: 2px solid rgba(239,68,68,0.70);
      outline-offset: 2px;
    }
    .dot-x{
      position:absolute;
      top:-8px;
      right:-8px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:none;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      line-height: 1;
      border: 1px solid rgba(239,68,68,0.35);
      background: rgba(255,255,255,0.85);
      color: rgba(239,68,68,0.95);
      box-shadow: 0 10px 24px rgba(15,23,42,0.14);
      cursor: pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    html[data-theme="dark"] .dot-x{
      background: rgba(255,255,255,0.10);
      color: rgba(248,113,113,0.95);
      border-color: rgba(248,113,113,0.25);
      box-shadow: 0 10px 24px rgba(0,0,0,0.30);
    }
    .dot-wrap.delete-mode .dot-x{ display:flex; }

    .small-muted{ color: var(--muted); font-size: 13px; line-height: 1.35; }
    #todayMicrocopy{
      letter-spacing: 0.005em;
      font-style: italic;
      opacity: 0.95;
      white-space: pre-wrap;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      font-size: 13px;
      color: var(--muted);
    }
    html[data-theme="dark"] .pill{ background: rgba(255,255,255,0.06); }

    .pill-good{
      border-color: var(--goodBorder);
      background: var(--goodTint);
      color: var(--text);
    }
    .pill-pause{
      border-color: var(--pauseBorder);
      background: var(--pauseTint);
      color: var(--text);
    }

    .surprise{
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px dashed rgba(37,99,235,0.28);
      background: radial-gradient(900px 260px at 20% 0%, rgba(37,99,235,0.10), transparent 55%),
                  rgba(255,255,255,0.55);
      color: rgba(15,23,42,0.82);
    }
    html[data-theme="dark"] .surprise{
      background: radial-gradient(900px 260px at 20% 0%, rgba(37,99,235,0.18), transparent 55%),
                  rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.86);
      border-color: rgba(37,99,235,0.28);
    }

    .ghost-btn{
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--text);
      font-size: 14px;
      transition: transform .06s ease, background .16s ease, opacity .16s ease;
      user-select:none; -webkit-user-select:none;
    }
    html[data-theme="dark"] .ghost-btn{ background: rgba(255,255,255,0.06); }
    .ghost-btn:active{ transform: translateY(1px); }

    .note-btn{
      border-radius: 14px;
      padding: 8px 10px;
      font-size: 13px;
      border: 1px solid rgba(37,99,235,0.22);
      background: rgba(37,99,235,0.10);
      color: rgba(37,99,235,0.95);
      user-select:none; -webkit-user-select:none;
      transition: transform .06s ease, filter .08s ease;
      flex: 0 0 auto;
    }
    html[data-theme="dark"] .note-btn{
      border-color: rgba(37,99,235,0.26);
      background: rgba(37,99,235,0.16);
      color: rgba(147,197,253,0.95);
    }
    .note-btn:active{ transform: translateY(1px); filter: brightness(0.98); }

    .inline-note{
      margin-top: 10px;
      width: 100%;
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,0.55);
      padding: 10px 10px;
      display:none;
      align-items:center;
      gap: 8px;
      overflow: hidden;
    }
    html[data-theme="dark"] .inline-note{ background: rgba(255,255,255,0.06); }
    .inline-note.show{ display:flex; }

    .inline-input{
      flex: 1 1 auto;
      min-width: 0;
      border: none;
      background: transparent;
      padding: 8px 6px;
      font-size: 14px;
      color: var(--text);
      outline: none;
    }

    .inline-x{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--muted);
      display:flex; align-items:center; justify-content:center;
      user-select:none; -webkit-user-select:none;
      transition: transform .06s ease;
      flex: 0 0 auto;
    }
    html[data-theme="dark"] .inline-x{ background: rgba(255,255,255,0.06); }
    .inline-x:active{ transform: translateY(1px); }

    .export-box{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,0.55);
      padding: 12px 14px;
    }
    html[data-theme="dark"] .export-box{ background: rgba(255,255,255,0.06); }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-bottom));
      z-index: 50;
      width: min(92vw, 420px);
      display:none;
      pointer-events: none;
    }
    .toast.show{ display:block; }
    .toast .inner{
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.75);
      box-shadow: 0 18px 50px rgba(15,23,42,0.12);
      color: rgba(15,23,42,0.88);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-size: 14px;
      pointer-events: auto;
    }
    html[data-theme="dark"] .toast .inner{
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.90);
      box-shadow: 0 18px 50px rgba(0,0,0,0.38);
    }

    /* ‚úÖ FIX: modal cannot block clicks when hidden */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 60;

      display: none;              /* <-- key fix */
      align-items: flex-end;
      justify-content: center;
      padding: 12px 12px calc(12px + var(--safe-bottom));

      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease;
    }
    .modal.open{ display:flex; }  /* opened layout only when needed */
    .modal.show{
      opacity: 1;
      pointer-events: auto;
    }

    .modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.26);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      opacity: 0;
      transition: opacity 180ms ease;
    }
    .modal.show .modal-backdrop{ opacity: 1; }
    html[data-theme="dark"] .modal-backdrop{ background: rgba(0,0,0,0.45); }

    .modal-sheet{
      position: relative;
      width: min(520px, 100%);
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      padding: 12px;

      transform: translateY(18px) scale(0.98);
      opacity: 0.98;
      transition: transform 200ms ease, opacity 200ms ease;
      will-change: transform;

      --flashBgStart: rgba(37,99,235,0.30);
      --flashBorderStart: rgba(37,99,235,0.45);
    }

    .modal.show .modal-sheet{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .sheet-top{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .sheet-title{
      font-weight: 750;
      letter-spacing:-0.02em;
      font-size: 15px;
      line-height: 1.1;
    }
    .sheet-sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .icon-close{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-user-select:none;
      transition: transform .06s ease;
      flex: 0 0 auto;
    }
    html[data-theme="dark"] .icon-close{ background: rgba(255,255,255,0.06); }
    .icon-close:active{ transform: translateY(1px); }

    .chips{
      margin-top: 10px;
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: calc(52vh);
      overflow: auto;
      padding-right: 2px;
      -webkit-overflow-scrolling: touch;
    }
    .chips::-webkit-scrollbar{ width: 0; height: 0; }

    .chip{
      border-radius: 999px;
      padding: 9px 11px;
      border: 1px solid var(--stroke);
      background: var(--chipBg);
      color: var(--text);
      font-size: 13px;
      transition: transform .06s ease, background .14s ease, border-color .14s ease;
      user-select:none;
      -webkit-user-select:none;
      position: relative;
      line-height: 1;
    }
    .chip:active{ transform: translateY(1px); }
    .chip.active{
      background: var(--goodTint);
      border-color: var(--goodBorder);
    }
    .chip.add{
      border-style: dashed;
      border-color: rgba(37,99,235,0.28);
    }
    .chip.soft{
      background: var(--chipBgSoft);
      color: var(--muted);
    }

    .chip.delete-mode{
      outline: 2px solid rgba(239,68,68,0.70);
      outline-offset: 2px;
    }
    .chip-x{
      position:absolute;
      top:-7px;
      right:-7px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:none;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      line-height: 1;
      border: 1px solid rgba(239,68,68,0.35);
      background: rgba(255,255,255,0.85);
      color: rgba(239,68,68,0.95);
      box-shadow: 0 10px 24px rgba(15,23,42,0.14);
    }
    html[data-theme="dark"] .chip-x{
      background: rgba(255,255,255,0.10);
      color: rgba(248,113,113,0.95);
      border-color: rgba(248,113,113,0.25);
      box-shadow: 0 10px 24px rgba(0,0,0,0.30);
    }
    .chip.delete-mode .chip-x{ display:flex; }

    .custom-wrap{
      margin-top: 10px;
      display:none;
      gap: 8px;
      align-items:center;
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,0.55);
      padding: 8px 8px;
    }
    html[data-theme="dark"] .custom-wrap{ background: rgba(255,255,255,0.06); }
    .custom-wrap.show{ display:flex; }

    .custom-input{
      flex: 1 1 auto;
      border: none;
      background: transparent;
      padding: 10px 10px;
      font-size: 14px;
      color: var(--text);
      outline: none;
      min-width: 0;
    }

    .mini-icon{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-user-select:none;
      transition: transform .06s ease, filter .08s ease;
      flex: 0 0 auto;
    }
    html[data-theme="dark"] .mini-icon{ background: rgba(255,255,255,0.06); }
    .mini-icon.primary{
      border-color: rgba(37,99,235,0.25);
      background: rgba(37,99,235,0.10);
      color: rgba(37,99,235,0.95);
    }
    html[data-theme="dark"] .mini-icon.primary{
      border-color: rgba(37,99,235,0.28);
      background: rgba(37,99,235,0.16);
      color: rgba(147,197,253,0.95);
    }
    .mini-icon:active{ transform: translateY(1px); filter: brightness(0.98); }

    .today-hint{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      opacity: 0.78;
      line-height: 1.35;
    }

    .topic-row{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      background: rgba(255,255,255,0.55);
      width: 100%;
      text-align:left;
    }
    html[data-theme="dark"] .topic-row{ background: rgba(255,255,255,0.06); }
    .topic-row.good{
      background: var(--goodTint);
      border-color: var(--goodBorder);
    }
    .topic-row.pause{
      background: var(--pauseTint);
      border-color: var(--pauseBorder);
    }
    .topic-left{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .topic-title{
      font-weight: 650;
      letter-spacing: -0.02em;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .topic-sub{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .delta-pill{
      font-size: 12px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--text);
      min-width: 46px;
      text-align:center;
      flex: 0 0 auto;
    }
    html[data-theme="dark"] .delta-pill{ background: rgba(255,255,255,0.06); }
    .delta-pill.good{
      background: var(--goodTint);
      border-color: var(--goodBorder);
    }
    .delta-pill.pause{
      background: var(--pauseTint);
      border-color: var(--pauseBorder);
    }

    .topic-details{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      display:none;
      padding-left: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .topic-details.show{ display:block; }

    .breath-wrap{
      display:flex; flex-direction:column; align-items:center; gap: 12px;
      padding: 10px 0 2px;
    }
    .breath-shadow{
      filter: drop-shadow(0 22px 60px rgba(37,99,235,0.18));
      -webkit-filter: drop-shadow(0 22px 60px rgba(37,99,235,0.18));
    }
    html[data-theme="dark"] .breath-shadow{
      filter: drop-shadow(0 26px 70px rgba(0,0,0,0.45));
      -webkit-filter: drop-shadow(0 26px 70px rgba(0,0,0,0.45));
    }
    .breath-circle{
      position: relative;
      width: 190px;
      height: 190px;
      border-radius: 9999px;
      overflow: hidden;
      -webkit-mask-image: radial-gradient(circle at center, #000 99.4%, transparent 100%);
      mask-image: radial-gradient(circle at center, #000 99.4%, transparent 100%);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: cover;
      mask-size: cover;
      display:flex; align-items:center; justify-content:center;
      color: white;
      font-weight: 700;
      letter-spacing: -0.02em;
      transform: translateZ(0) scale(0.78);
      will-change: transform;
      backface-visibility: hidden;
      border: 1px solid rgba(255,255,255,0.14);
      user-select:none;
      -webkit-user-select:none;
      background: rgba(37,99,235,0.95);
    }
    .breath-circle::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      background: conic-gradient(from 180deg,
        rgba(37,99,235,1),
        rgba(29,78,216,1),
        rgba(124,58,237,1),
        rgba(37,99,235,1)
      );
      animation: spin 10s linear infinite;
      opacity: 0.98;
      transform: translateZ(0);
    }
    .breath-circle::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      background: radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,0.28), transparent 60%),
                  rgba(0,0,0,0.10);
      mix-blend-mode: soft-light;
      transform: translateZ(0);
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .breath-circle > span{
      position: relative;
      z-index: 2;
      text-align:center;
      padding: 0 12px;
    }
    .breath-sub{
      font-size: 14px;
      color: var(--muted);
      text-align:center;
    }

    @keyframes dotPop {
      0%   { transform: scale(0.82); }
      60%  { transform: scale(1.12); }
      100% { transform: scale(1.00); }
    }
    .dot.pop {
      animation: dotPop 220ms ease-out;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--muted);
      user-select:none;
      -webkit-user-select:none;
    }
    html[data-theme="dark"] .badge{ background: rgba(255,255,255,0.06); }

    .badge-good{
      background: var(--goodTint);
      border-color: var(--goodBorder);
      color: var(--text);
    }
    .badge-pause{
      background: var(--pauseTint);
      border-color: var(--pauseBorder);
      color: var(--text);
    }

    @keyframes chipFlash {
      0%   { background: var(--flashBgStart); border-color: var(--flashBorderStart); }
      100% { background: var(--chipBg);      border-color: var(--stroke); }
    }
    .modal-sheet .chip.flash{
      animation: chipFlash 160ms ease-out;
    }
  </style>
</head>

<body>
  <div class="app-wrap max-w-md mx-auto px-4">
    <div class="segmented card p-0 mb-4" style="box-shadow:none;">
      <button class="tab-btn active" data-tab="today">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="tab-btn" data-tab="summary">–ò—Ç–æ–≥–∏</button>
      <button class="tab-btn" data-tab="breath">–î—ã—Ö–∞–Ω–∏–µ</button>
      <button class="tab-btn" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <!-- TODAY -->
    <section id="tab-today">
      <div class="card p-4 mb-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0 flex-1">
            <div class="text-base font-semibold" style="letter-spacing:-0.02em;">–û—Ç–º–µ—Ç–∏—Ç—å –º–æ–º–µ–Ω—Ç</div>
            <div class="small-muted" id="todayMicrocopy">–û–¥–∏–Ω —à–∞–≥ ‚Äî —É–∂–µ –¥–≤–∏–∂–µ–Ω–∏–µ.</div>

            <div id="dayNoteWrap" class="inline-note">
              <input id="dayNoteInput" class="inline-input" maxlength="40" placeholder="–¢–µ–º–∞ –¥–Ω—è (1‚Äì2 —Å–ª–æ–≤–∞)‚Ä¶" />
              <button id="dayNoteClose" class="inline-x" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
            </div>

            <div id="dayNoteSaved" class="small-muted mt-2" style="display:none;"></div>
          </div>

          <button id="btnDayNote" class="note-btn" type="button">–ó–∞–º–µ—Ç–∫–∞</button>
        </div>
      </div>

      <div class="grid gap-3 mb-4">
        <button id="btnGood" class="action-btn action-primary">–ü–æ–ª–µ–∑–Ω–æ–µ –¥–ª—è —Å–µ–±—è</button>
        <button id="btnPause" class="action-btn action-neutral">–®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É</button>
      </div>

      <div class="card p-4" id="todayCard">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">–°–µ–≥–æ–¥–Ω—è</div>
          <button id="btnClearToday" class="ghost-btn" style="padding:8px 10px; font-size:13px; border-radius:14px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="todayDots" class="dot-row"></div>
        <div id="todayEmpty" class="small-muted mt-2" style="display:none;">
          –ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ ‚Äî –∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
        </div>

        <div class="today-hint">
          –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫—Ä—É–∂–æ—á–µ–∫ ‚Üí –ø–æ—è–≤–∏—Ç—Å—è √ó ‚Üí –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å. –¢–∞–ø –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É –≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è.
        </div>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="tab-summary" class="hidden">
      <div class="card p-4 mb-4">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-base font-semibold" style="letter-spacing:-0.02em;">–ò—Ç–æ–≥–∏ –¥–Ω—è</div>
            <div class="small-muted" id="summaryDate"></div>
          </div>
        </div>

        <div id="summaryDayNote" class="small-muted mb-2" style="display:none;"></div>

        <div class="flex items-center gap-2 mb-3">
          <span class="pill pill-good" id="pillGood">–ü–æ–ª–µ–∑–Ω–æ–µ: 0</span>
          <span class="pill pill-pause" id="pillPause">–®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É: 0</span>
        </div>

        <div id="summaryDots" class="dot-row mb-3"></div>

        <div id="surpriseBox" class="surprise" style="display:none;"></div>

        <div class="mt-3 small-muted whitespace-pre-wrap" id="dailyText"></div>
      </div>

      <div class="card p-4 mb-4">
        <div class="text-base font-semibold mb-1" style="letter-spacing:-0.02em;">–¢–µ–º—ã –¥–Ω—è</div>
        <div class="small-muted mb-3">–°–ø—Ä–∞–≤–∞ ‚Äî —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∫–æ—Å (+/-). –ù–∞–∂–º–∏ —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.</div>

        <div id="topicsToday" class="grid gap-2"></div>
        <div id="topicsTodayEmpty" class="small-muted" style="display:none;">–ü–æ–∫–∞ –Ω–µ—Ç —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–º–µ—Ç–æ–∫ ‚Äî –∏ —ç—Ç–æ –æ–∫–µ–π.</div>

        <div class="mt-3 small-muted whitespace-pre-wrap" id="topicsHint"></div>
      </div>

      <div class="card p-4 mb-4">
        <div class="text-base font-semibold mb-1" style="letter-spacing:-0.02em;">–ù–µ–¥–µ–ª—è</div>
        <div class="small-muted mb-3">–°–µ–º—å –¥–Ω–µ–π ‚Äî –æ–¥–Ω–∞ –ª–∏–Ω–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏–π.</div>

        <div id="weekGrid" class="grid gap-2"></div>

        <div class="mt-3 small-muted whitespace-pre-wrap" id="weeklyText"></div>

        <div class="mt-4">
          <div class="text-sm font-semibold mb-2">–¢–µ–º—ã –Ω–µ–¥–µ–ª–∏</div>
          <div id="topicsWeek" class="grid gap-2"></div>
          <div id="topicsWeekEmpty" class="small-muted" style="display:none;">–ó–∞ –Ω–µ–¥–µ–ª—é –Ω–µ—Ç —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–º–µ—Ç–æ–∫.</div>
        </div>
      </div>
    </section>

    <!-- BREATH -->
    <section id="tab-breath" class="hidden">
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-base font-semibold" style="letter-spacing:-0.02em;">1 –º–∏–Ω—É—Ç–∞</div>
            <div class="small-muted">–î—ã—Ö–∞–Ω–∏–µ 4 ‚Ä¢ 4 ‚Ä¢ 4 ‚Ä¢ 4</div>
          </div>
          <button id="breathToggle" class="ghost-btn">–ù–∞—á–∞—Ç—å</button>
        </div>

        <div class="breath-wrap">
          <div class="breath-shadow">
            <div id="breathCircle" class="breath-circle" aria-label="–¥—ã—Ö–∞–Ω–∏–µ">
              <span id="breathLabel">–ì–æ—Ç–æ–≤–æ</span>
            </div>
          </div>
          <div class="breath-sub" id="breathSub">–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª –∏ –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É–π —Å—á—ë—Ç—É.</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="hidden">
      <div class="card p-4 mb-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">–¢–µ–º–∞</div>
        <div class="segmented" style="box-shadow:none;">
          <button class="tab-btn" data-theme="light" id="themeLight">‚òÄÔ∏é –°–≤–µ—Ç–ª–∞—è</button>
          <button class="tab-btn" data-theme="dark" id="themeDark">‚òæ –¢—ë–º–Ω–∞—è</button>
          <button class="tab-btn" data-theme="system" id="themeSystem">‚óØ –°–∏—Å—Ç–µ–º–Ω–∞—è</button>
        </div>
        <div class="small-muted mt-2">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å ¬´–°–∏—Å—Ç–µ–º–Ω–∞—è¬ª ‚Äî –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è.</div>
      </div>

      <div class="card p-4 mb-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</div>
        <div class="small-muted">–ï—Å–ª–∏ –≤–¥—Ä—É–≥ ¬´–Ω–∏—á–µ–≥–æ –Ω–µ –∫–ª–∏–∫–∞–µ—Ç—Å—è¬ª, —Ç—É—Ç —á–∞—Å—Ç–æ –≤–∏–¥–Ω–æ –ø—Ä–∏—á–∏–Ω—É.</div>
        <div class="mt-3 export-box small-muted whitespace-pre-wrap" id="debugBox" style="min-height:52px;">–û—à–∏–±–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
      </div>

      <div class="card p-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">–î–∞–Ω–Ω—ã–µ</div>
        <div class="small-muted">–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ ‚Äî –º–æ–∂–Ω–æ —Å—Ç–µ—Ä–µ—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é.</div>
        <div class="mt-3 flex gap-2">
          <button id="btnExport" class="ghost-btn flex-1">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <button id="btnReset" class="ghost-btn flex-1" style="border-color: rgba(37,99,235,0.25);">–°—Ç–µ—Ä–µ—Ç—å</button>
        </div>
        <pre id="exportBox" class="mt-3 hidden export-box small-muted whitespace-pre-wrap"></pre>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <div class="inner" id="toastInner">‚úì –ó–∞–ø–∏—Å–∞–Ω–æ</div>
  </div>

  <!-- Modal -->
  <div id="noteModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" id="noteBackdrop"></div>

    <div class="modal-sheet" id="noteSheet">
      <div class="sheet-top">
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <div class="sheet-title" id="noteTitle">–ü–æ–ª–µ–∑–Ω–æ–µ –¥–ª—è —Å–µ–±—è</div>
            <span id="noteBadge" class="badge badge-good">–ü–æ–ª–µ–∑–Ω–æ–µ</span>
          </div>
          <div class="sheet-sub" id="sheetSub">–í—ã–±–µ—Ä–∏ —Ç–µ–º—É ‚Äî 1 —Ç–∞–ø, –∏ –≥–æ—Ç–æ–≤–æ.</div>
        </div>
        <button id="noteClose" class="icon-close" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>

      <div class="chips" id="topicChips"></div>

      <div id="customTopicWrap" class="custom-wrap">
        <input id="customTopicInput" class="custom-input" placeholder="–°–≤–æ—è —Ç–µ–º–∞‚Ä¶" maxlength="24" />
        <button id="customTopicOk" class="mini-icon primary" title="–ì–æ—Ç–æ–≤–æ" aria-label="–ì–æ—Ç–æ–≤–æ">‚úì</button>
        <button id="customTopicCancel" class="mini-icon" title="–û—Ç–º–µ–Ω–∞" aria-label="–û—Ç–º–µ–Ω–∞">‚úï</button>
      </div>

      <div id="modalHint" class="today-hint" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    ;(() => {
      const tg = window.Telegram?.WebApp || null;
      try{ tg?.ready?.(); tg?.expand?.(); }catch(e){}

      const STORAGE = "balancecare_v24"; // FIX modal overlay + autoscroll
      const defaultState = () => ({
        theme: "system",
        events: [],
        customTopics: [],
        dayNotes: {},
        topicStats: {},
        surprise: { lastShownAt: null },
        ui: { microcopyDate: null, microcopyText: null },
        debug: { lastError: null }
      });

      let state = loadState();

      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE);
          if(raw){
            const parsed = JSON.parse(raw);
            return {
              ...defaultState(),
              ...parsed,
              ui: { ...defaultState().ui, ...(parsed.ui||{}) },
              surprise: { ...defaultState().surprise, ...(parsed.surprise||{}) },
              debug: { ...defaultState().debug, ...(parsed.debug||{}) },
              customTopics: Array.isArray(parsed.customTopics) ? parsed.customTopics : [],
              dayNotes: (parsed.dayNotes && typeof parsed.dayNotes === "object") ? parsed.dayNotes : {},
              topicStats: (parsed.topicStats && typeof parsed.topicStats === "object") ? parsed.topicStats : {}
            };
          }

          const prevKeys = [
            "balancecare_v23","balancecare_v22","balancecare_v21","balancecare_v20","balancecare_v19","balancecare_v18",
            "balancecare_v17","balancecare_v16","balancecare_v15","balancecare_v14","balancecare_v13","balancecare_v12"
          ];
          for(const k of prevKeys){
            const prev = localStorage.getItem(k);
            if(prev){
              const p = JSON.parse(prev);
              const migrated = {
                ...defaultState(),
                ...p,
                customTopics: Array.isArray(p.customTopics) ? p.customTopics : [],
                dayNotes: (p.dayNotes && typeof p.dayNotes === "object") ? p.dayNotes : {},
                topicStats: (p.topicStats && typeof p.topicStats === "object") ? p.topicStats : {}
              };
              localStorage.setItem(STORAGE, JSON.stringify(migrated));
              return migrated;
            }
          }
          return defaultState();
        }catch(e){
          return defaultState();
        }
      }

      function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }

      function pad(n){ return String(n).padStart(2,"0"); }
      function dateKey(d=new Date()){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
      function nowISO(){ return new Date().toISOString(); }

      function isLight(hex){
        try{
          const h = hex.replace("#","").trim();
          const full = h.length === 3 ? h.split("").map(x=>x+x).join("") : h;
          const n = parseInt(full,16);
          const r=(n>>16)&255, g=(n>>8)&255, b=n&255;
          const lum = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
          return lum > 0.6;
        }catch(e){ return true; }
      }

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      function toast(msg){
        const t = $("#toast");
        $("#toastInner").textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._t);
        toast._t = setTimeout(() => t.classList.remove("show"), 1100);
      }
      function haptic(kind="light"){
        try{
          if(tg?.HapticFeedback){
            if(kind==="success") tg.HapticFeedback.notificationOccurred("success");
            else tg.HapticFeedback.impactOccurred("light");
          }
        }catch(e){}
      }
      function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

      function setDebug(text){
        state.debug.lastError = text;
        save();
        const box = $("#debugBox");
        if(box) box.textContent = text || "–û—à–∏–±–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.";
      }

      window.addEventListener("error", (e) => {
        const msg = `–û—à–∏–±–∫–∞: ${e.message || "unknown"}\n–§–∞–π–ª: ${e.filename || "-"}:${e.lineno || "-"}:${e.colno || "-"}`;
        setDebug(msg);
        toast("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ");
      });
      window.addEventListener("unhandledrejection", (e) => {
        const msg = `Promise rejection: ${String(e.reason || "unknown")}`;
        setDebug(msg);
        toast("‚ö†Ô∏è –û—à–∏–±–∫–∞ (promise)");
      });

      let systemListenerAttached = false;

      function renderThemeButtons(){
        const map = { light:"themeLight", dark:"themeDark", system:"themeSystem" };
        ["themeLight","themeDark","themeSystem"].forEach(id => {
          const el = document.getElementById(id);
          if(!el) return;
          el.classList.remove("active");
          el.style.background = "transparent";
          el.style.color = "var(--muted)";
        });
        const activeId = map[state.theme] || "themeSystem";
        const activeEl = document.getElementById(activeId);
        if(activeEl){
          activeEl.classList.add("active");
          activeEl.style.background = "linear-gradient(180deg, var(--primary), var(--primary2))";
          activeEl.style.color = "white";
        }
      }

      function applyTheme(){
        if(state.theme === "light"){
          document.documentElement.setAttribute("data-theme","light");
        }else if(state.theme === "dark"){
          document.documentElement.setAttribute("data-theme","dark");
        }else{
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          document.documentElement.setAttribute("data-theme", prefersDark ? "dark" : "light");
          if(!systemListenerAttached && window.matchMedia){
            systemListenerAttached = true;
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
              if(state.theme === "system") applyTheme();
            });
          }
        }

        try{
          const tp = tg?.themeParams || {};
          const bg = tp.bg_color;
          if(state.theme === "system" && bg){
            document.documentElement.setAttribute("data-theme", isLight(bg) ? "light" : "dark");
          }
        }catch(e){}

        renderThemeButtons();
      }

      const MICRO_SHORT = [
        "–û–¥–∏–Ω —à–∞–≥ ‚Äî —É–∂–µ –¥–≤–∏–∂–µ–Ω–∏–µ.",
        "–ú–æ–∂–Ω–æ –ø–æ-–¥–æ–±—Ä–æ–º—É –∫ —Å–µ–±–µ.",
        "–ó–∞–º–µ—á–∞—Ç—å ‚Äî —Ç–æ–∂–µ –Ω–∞–≤—ã–∫.",
        "–ß—É—Ç—å —è—Å–Ω–µ–µ ‚Äî —É–∂–µ –ª–µ–≥—á–µ.",
        "–ú–∞–ª–µ–Ω—å–∫–æ–µ —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è.",
        "–ü–∞—É–∑–∞ ‚Äî —ç—Ç–æ –≤–æ–∑–¥—É—Ö.",
        "–ë–µ–∑ –≥–æ–Ω–∫–∏. –ü—Ä–æ—Å—Ç–æ –¥–µ–Ω—å.",
        "–û—Ç–º–µ—Ç–∏—Ç—å ‚Äî –∏ –æ—Ç–ø—É—Å—Ç–∏—Ç—å.",
        "–ß–µ—Å—Ç–Ω–æ—Å—Ç—å —Å —Å–æ–±–æ–π ‚Äî —Å–∏–ª–∞.",
        "–ú—è–≥–∫–æ ‚Äî —Ç–æ–∂–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ."
      ];
      const MICRO_LONG = [
        "–ù–µ –Ω—É–∂–Ω–æ ¬´–∏–¥–µ–∞–ª—å–Ω–æ¬ª.\n–ù—É–∂–Ω–æ —Ç–∞–∫, —á—Ç–æ–±—ã –±—ã–ª–æ —É—Å—Ç–æ–π—á–∏–≤–æ.",
        "–ó–¥–µ—Å—å —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è —Ñ–∞–∫—Ç—ã.\n–û—Ç —ç—Ç–æ–≥–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ø–æ–∫–æ–π–Ω–µ–µ.",
        "–î–µ–Ω—å –Ω–µ –æ–±—è–∑–∞–Ω –±—ã—Ç—å —Ä–æ–≤–Ω—ã–º.\n–í–∞–∂–Ω–æ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å —Å–æ–±–æ–π.",
        "–ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —Å–ª–æ–∂–Ω–æ ‚Äî –æ–∫–µ–π.\n–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è."
      ];
      function pickQuote(){
        const useLong = Math.random() < 0.5;
        return useLong ? pick(MICRO_LONG) : pick(MICRO_SHORT);
      }
      function ensureMicrocopyForToday(){
        const d = dateKey();
        if(state.ui.microcopyDate !== d || !state.ui.microcopyText){
          state.ui.microcopyDate = d;
          state.ui.microcopyText = pickQuote();
          save();
        }
        $("#todayMicrocopy").textContent = state.ui.microcopyText;
      }

      let currentTab = "today";
      function setTab(name){
        currentTab = name;
        $$(".tab-btn[data-tab]").forEach(btn => btn.classList.toggle("active", btn.dataset.tab === name));
        ["today","summary","breath","settings"].forEach(t => $("#tab-"+t).classList.toggle("hidden", t !== name));

        if(name === "today") ensureMicrocopyForToday();
        if(name === "summary") renderSummary();
        if(name !== "breath") stopBreathing(false);
      }
      $$(".tab-btn[data-tab]").forEach(btn => btn.addEventListener("click", () => setTab(btn.dataset.tab)));

      const BASE_TOPICS = [
        { id:"food", label:"üçΩ –ü–∏—Ç–∞–Ω–∏–µ" },
        { id:"body", label:"üí™ –¢–µ–ª–æ" },
        { id:"rel",  label:"ü§ù –û—Ç–Ω–æ—à–µ–Ω–∏—è" }
      ];

      function allTopics(){
        const custom = (state.customTopics || []).map(t => ({ id: t.id, label: "üîñ " + t.label, custom:true }));
        return [...BASE_TOPICS.map(x=>({ ...x, custom:false })), ...custom];
      }

      function topicLabel(id){
        const found = allTopics().find(t => t.id === id);
        if(found) return found.label;
        return "üîñ –°–≤–æ—è —Ç–µ–º–∞";
      }

      function normalizeCustomLabel(s){
        return (s || "").trim().replace(/\s+/g, " ").slice(0, 24);
      }

      function makeCustomId(label){
        const base = label.toLowerCase()
          .replace(/[^\p{L}\p{N}]+/gu, "-")
          .replace(/^-+|-+$/g, "")
          .slice(0, 18) || "topic";
        return "c_" + base + "_" + Math.random().toString(16).slice(2, 6);
      }

      function addCustomTopic(label){
        const clean = normalizeCustomLabel(label);
        if(!clean) return null;

        const exists = (state.customTopics || []).find(t => t.label.toLowerCase() === clean.toLowerCase());
        if(exists) return exists.id;

        const id = makeCustomId(clean);
        state.customTopics = [...(state.customTopics || []), { id, label: clean }];
        save();
        return id;
      }

      function removeCustomTopic(topicId){
        state.customTopics = (state.customTopics || []).filter(t => t.id !== topicId);
        state.events.forEach(e=>{
          if(e.topic === topicId) e.topic = null;
        });
        delete (state.topicStats || {})[topicId];
        save();
      }

      function bumpTopicStat(topicId){
        if(!topicId) return;
        if(!state.topicStats) state.topicStats = {};
        state.topicStats[topicId] = (state.topicStats[topicId] || 0) + 1;
      }

      function modalTopicsSorted(){
        const topics = allTopics().slice();
        const stats = state.topicStats || {};
        topics.sort((a,b)=>{
          const sa = stats[a.id] || 0;
          const sb = stats[b.id] || 0;
          if(sb !== sa) return sb - sa;
          if(a.custom !== b.custom) return a.custom ? 1 : -1;
          return a.label.localeCompare(b.label);
        });
        return topics;
      }

      function getFrequentTopics(limit=4){
        const topics = allTopics();
        const stats = state.topicStats || {};
        const candidates = topics
          .map(t => ({ ...t, s: stats[t.id] || 0 }))
          .sort((a,b)=> b.s - a.s || (a.custom!==b.custom ? (a.custom?1:-1) : a.label.localeCompare(b.label)));

        const out = [];
        const used = new Set();

        for(const t of candidates){
          if(out.length >= limit) break;
          if(used.has(t.id)) continue;
          if(t.s <= 0) continue;
          out.push(t);
          used.add(t.id);
        }

        if(out.length < limit){
          for(const t of BASE_TOPICS.map(x=>({ ...x, custom:false }))){
            if(out.length >= limit) break;
            if(used.has(t.id)) continue;
            out.push(t); used.add(t.id);
          }
        }
        if(out.length < limit){
          for(const t of (state.customTopics||[]).map(t=>({id:t.id,label:"üîñ "+t.label,custom:true}))){
            if(out.length >= limit) break;
            if(used.has(t.id)) continue;
            out.push(t); used.add(t.id);
          }
        }
        return out.slice(0, limit);
      }

      let pendingEventId = null;
      let pendingEventType = "good";
      let selectedTopic = null;

      let lastAddedEventId = null;

      function ensureEventIds(){
        let changed = false;
        state.events.forEach(ev=>{
          if(!ev.id){
            ev.id = "e_" + Math.random().toString(16).slice(2) + "_" + Date.now();
            changed = true;
          }
        });
        if(changed) save();
      }

      function showCustomTopicInput(show){
        const wrap = $("#customTopicWrap");
        wrap.classList.toggle("show", !!show);
        if(show){
          $("#customTopicInput").value = "";
          setTimeout(() => $("#customTopicInput").focus(), 0);
        }
      }

      function clearChipDeleteModes(){
        $$(".chip.delete-mode").forEach(ch => ch.classList.remove("delete-mode"));
      }

      function attachLongPress(el, onLongPress, ms=520){
        let t = null;
        const clear = () => { if(t){ clearTimeout(t); t = null; } };
        el.addEventListener("pointerdown", () => { clear(); t = setTimeout(() => onLongPress(), ms); }, { passive: true });
        el.addEventListener("pointermove", () => { clear(); }, { passive: true });
        el.addEventListener("pointerup", () => { clear(); }, { passive: true });
        el.addEventListener("pointercancel", () => { clear(); }, { passive: true });
        el.addEventListener("contextmenu", (e) => e.preventDefault());
      }

      function getPendingEvent(){
        if(!pendingEventId) return null;
        return state.events.find(x => x.id === pendingEventId) || null;
      }

      function autosavePendingEventTopic(topic){
        const ev = getPendingEvent();
        if(!ev) return;
        ev.topic = topic || null;
        bumpTopicStat(ev.topic);
        save();
        if(currentTab === "summary") renderSummary();
      }

      let modalMode = "quick"; // "quick" | "all"

      function setModalMode(mode){
        modalMode = mode;

        const sub = $("#sheetSub");
        const hint = $("#modalHint");

        if(modalMode === "quick"){
          sub.textContent = "–í—ã–±–µ—Ä–∏ —Ç–µ–º—É ‚Äî 1 —Ç–∞–ø, –∏ –≥–æ—Ç–æ–≤–æ.";
          if(hint) hint.textContent = "–ù—É–∂–Ω—ã –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã? –ù–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ¬ª –∏–ª–∏ –¥–æ–±–∞–≤—å —Å–≤–æ—é.";
        }else{
          sub.textContent = "–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–µ–º.";
          if(hint) hint.textContent = "–î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ —Å–≤–æ—é —Ç–µ–º—É ‚Üí –ø–æ—è–≤–∏—Ç—Å—è √ó ‚Üí –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.";
        }

        showCustomTopicInput(false);
        clearChipDeleteModes();
        renderTopicChips();
      }

      function flashChip(el){
        el.classList.remove("flash");
        void el.offsetWidth;
        el.classList.add("flash");
        setTimeout(() => el.classList.remove("flash"), 220);
      }

      function renderTopicChips(){
        const wrap = $("#topicChips");
        wrap.innerHTML = "";

        const makeChip = (t, {allowDelete=false} = {}) => {
          const b = document.createElement("button");
          b.className = "chip";
          b.type = "button";
          b.textContent = t.label;
          b.dataset.topic = t.id;

          if(allowDelete && t.custom){
            const x = document.createElement("span");
            x.className = "chip-x";
            x.textContent = "√ó";
            x.title = "–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É";
            x.addEventListener("click", (evt) => {
              evt.stopPropagation();
              removeCustomTopic(t.id);
              clearChipDeleteModes();
              renderTopicChips();
              toast("–¢–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞");
              haptic("light");
            });
            b.appendChild(x);

            attachLongPress(b, () => {
              clearChipDeleteModes();
              b.classList.add("delete-mode");
              haptic("light");
            });
          }

          b.addEventListener("click", () => {
            if(b.classList.contains("delete-mode")){
              b.classList.remove("delete-mode");
              return;
            }

            flashChip(b);

            selectedTopic = t.id;
            showCustomTopicInput(false);
            $$("#topicChips .chip").forEach(x=>x.classList.toggle("active", x.dataset.topic === selectedTopic));

            autosavePendingEventTopic(selectedTopic);
            toast("‚úì –¢–µ–º–∞ –æ—Ç–º–µ—á–µ–Ω–∞");
            haptic("success");
            setTimeout(() => closeNoteModal(), 140);
          });

          return b;
        };

        if(modalMode === "quick"){
          const frequent = getFrequentTopics(4);
          frequent.forEach(t => wrap.appendChild(makeChip(t)));

          const more = document.createElement("button");
          more.className = "chip soft";
          more.type = "button";
          more.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ";
          more.addEventListener("click", () => setModalMode("all"));
          wrap.appendChild(more);

          const add = document.createElement("button");
          add.className = "chip add";
          add.type = "button";
          add.textContent = "Ôºã –°–≤–æ—è —Ç–µ–º–∞";
          add.addEventListener("click", () => {
            selectedTopic = null;
            $$("#topicChips .chip").forEach(x=>x.classList.remove("active"));
            clearChipDeleteModes();
            showCustomTopicInput(true);
          });
          wrap.appendChild(add);
          return;
        }

        const back = document.createElement("button");
        back.className = "chip soft";
        back.type = "button";
        back.textContent = "‚Üê –ù–∞–∑–∞–¥";
        back.addEventListener("click", () => setModalMode("quick"));
        wrap.appendChild(back);

        const add = document.createElement("button");
        add.className = "chip add";
        add.type = "button";
        add.textContent = "Ôºã –°–≤–æ—è —Ç–µ–º–∞";
        add.addEventListener("click", () => {
          selectedTopic = null;
          $$("#topicChips .chip").forEach(x=>x.classList.remove("active"));
          clearChipDeleteModes();
          showCustomTopicInput(true);
        });
        wrap.appendChild(add);

        modalTopicsSorted().forEach(t => wrap.appendChild(makeChip(t, { allowDelete:true })));
      }

      function openNoteModal({ type, eventId }){
        pendingEventId = eventId || null;
        pendingEventType = type || "good";
        selectedTopic = null;
        modalMode = "quick";

        const sheet = $("#noteSheet");
        if(sheet){
          if(pendingEventType === "good"){
            sheet.style.setProperty("--flashBgStart", "rgba(37,99,235,0.30)");
            sheet.style.setProperty("--flashBorderStart", "rgba(37,99,235,0.45)");
          }else{
            sheet.style.setProperty("--flashBgStart", "rgba(148,163,184,0.26)");
            sheet.style.setProperty("--flashBorderStart", "rgba(148,163,184,0.40)");
          }
        }

        $("#noteTitle").textContent = (pendingEventType === "good") ? "–ü–æ–ª–µ–∑–Ω–æ–µ –¥–ª—è —Å–µ–±—è" : "–®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É";

        const badge = $("#noteBadge");
        if(badge){
          if(pendingEventType === "good"){
            badge.textContent = "–ü–æ–ª–µ–∑–Ω–æ–µ";
            badge.classList.add("badge-good");
            badge.classList.remove("badge-pause");
          }else{
            badge.textContent = "–®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É";
            badge.classList.add("badge-pause");
            badge.classList.remove("badge-good");
          }
        }

        const hint = $("#modalHint");
        $("#sheetSub").textContent = "–í—ã–±–µ—Ä–∏ —Ç–µ–º—É ‚Äî 1 —Ç–∞–ø, –∏ –≥–æ—Ç–æ–≤–æ.";
        if(hint) hint.textContent = "–ù—É–∂–Ω—ã –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã? –ù–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ¬ª –∏–ª–∏ –¥–æ–±–∞–≤—å —Å–≤–æ—é.";

        showCustomTopicInput(false);
        clearChipDeleteModes();
        renderTopicChips();

        const ev = getPendingEvent();
        if(ev?.topic){
          selectedTopic = ev.topic;
          $$("#topicChips .chip").forEach(x=>x.classList.toggle("active", x.dataset.topic === selectedTopic));
        }

        const modal = $("#noteModal");
        modal.classList.add("open"); // display:flex
        requestAnimationFrame(() => modal.classList.add("show")); // animate opacity/transform
        modal.setAttribute("aria-hidden","false");
      }

      function closeNoteModal(){
        const modal = $("#noteModal");
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden","true");

        setTimeout(() => {
          modal.classList.remove("open"); // display:none again (cannot block clicks)
        }, 220);

        pendingEventId = null;
        selectedTopic = null;
        modalMode = "quick";
        showCustomTopicInput(false);
        clearChipDeleteModes();
      }

      function eventsFor(d){ return state.events.filter(e => e.date === d); }
      function countFor(d){
        const ev = eventsFor(d);
        const good = ev.filter(x => x.type === "good").length;
        const pause = ev.filter(x => x.type === "pause").length;
        return { good, pause, total: ev.length, ev };
      }

      function deleteEventById(id){
        const before = state.events.length;
        state.events = state.events.filter(e => e.id !== id);
        if(state.events.length !== before){
          save();
          renderToday();
          if(currentTab === "summary") renderSummary();
          toast("–£–¥–∞–ª–µ–Ω–æ");
          haptic("light");
        }
      }

      function clearAllDeleteModes(){
        $$(".dot-wrap.delete-mode").forEach(el => el.classList.remove("delete-mode"));
        clearChipDeleteModes();
      }

      function installDeleteModeAutoClose(){
        document.addEventListener("pointerdown", (e) => {
          if($$(".dot-wrap.delete-mode").length === 0 && $$(".chip.delete-mode").length === 0) return;
          const insideDot = e.target.closest && e.target.closest(".dot-wrap");
          const insideChip = e.target.closest && e.target.closest(".chip");
          if(insideDot || insideChip) return;
          clearAllDeleteModes();
        }, true);
      }

      function renderDots(container, ev, allowDelete=false){
        container.innerHTML = "";
        ev.slice(-48).forEach(e => {
          if(!allowDelete){
            const dot = document.createElement("div");
            dot.className = "dot " + (e.type === "good" ? "good" : "pause");
            container.appendChild(dot);
            return;
          }

          const wrap = document.createElement("div");
          wrap.className = "dot-wrap";
          wrap.dataset.id = e.id;

          const dot = document.createElement("div");
          dot.className = "dot " + (e.type === "good" ? "good" : "pause");

          const x = document.createElement("div");
          x.className = "dot-x";
          x.textContent = "√ó";
          x.title = "–£–¥–∞–ª–∏—Ç—å";

          x.addEventListener("click", (evt) => {
            evt.stopPropagation();
            deleteEventById(e.id);
          });

          attachLongPress(wrap, () => {
            clearAllDeleteModes();
            wrap.classList.add("delete-mode");
            haptic("light");
          });

          wrap.addEventListener("click", () => {
            if(wrap.classList.contains("delete-mode")){
              wrap.classList.remove("delete-mode");
            }
          });

          wrap.appendChild(dot);
          wrap.appendChild(x);
          container.appendChild(wrap);
        });
      }

      /* ‚úÖ Autoscroll helper */
      function scrollToLastDot(){
        const row = $("#todayDots");
        if(!row) return;
        const last = row.querySelector(".dot-wrap:last-child");
        if(!last) return;

        // smooth scroll inside page to keep last dot visible
        last.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "nearest" });
      }

      function renderToday(){
        const d = dateKey();
        const { ev, total } = countFor(d);
        const row = $("#todayDots");
        const empty = $("#todayEmpty");

        if(total === 0){
          row.innerHTML = "";
          empty.style.display = "block";
        }else{
          empty.style.display = "none";
          renderDots(row, ev, true);

          if(lastAddedEventId){
            const wrap = row.querySelector(`[data-id="${lastAddedEventId}"]`);
            const dot = wrap ? wrap.querySelector(".dot") : null;
            if(dot){
              dot.classList.add("pop");
              setTimeout(() => dot.classList.remove("pop"), 260);
            }
            // ‚úÖ autoscroll after render
            setTimeout(scrollToLastDot, 0);

            lastAddedEventId = null;
          }
        }

        const note = (state.dayNotes && state.dayNotes[d]) ? String(state.dayNotes[d]).trim() : "";
        const saved = $("#dayNoteSaved");
        if(note){
          saved.style.display = "block";
          saved.textContent = `–¢–µ–º–∞ –¥–Ω—è: ${note}`;
        }else{
          saved.style.display = "none";
          saved.textContent = "";
        }
      }

      function addEvent(type){
        const id = "e_" + Math.random().toString(16).slice(2) + "_" + Date.now();
        lastAddedEventId = id;

        state.events.push({ id, ts: nowISO(), date: dateKey(), type, topic: null });
        save();
        renderToday();
        if(currentTab === "summary") renderSummary();
        toast("‚úì –û—Ç–º–µ—á–µ–Ω–æ");
        haptic("success");

        openNoteModal({ type, eventId: id });
      }

      function clearToday(){
        const d = dateKey();
        state.events = state.events.filter(e => e.date !== d);
        delete state.dayNotes[d];
        save();
        renderToday();
        if(currentTab === "summary") renderSummary();
        toast("–û—á–∏—â–µ–Ω–æ");
        haptic("light");
      }

      const SURPRISE_LINES = [
        "–ó–¥–µ—Å—å —É–∂–µ –µ—Å—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å: –∑–∞–º–µ—á–∞—Ç—å –∏ –Ω–µ –¥–∞–≤–∏—Ç—å –Ω–∞ —Å–µ–±—è.",
        "–í–∏–¥–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ. –î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–æ–µ ‚Äî –Ω–∞—Å—Ç–æ—è—â–µ–µ.",
        "–í—ã–±–æ—Ä —è—Å–Ω–æ—Å—Ç–∏ –≤–º–µ—Å—Ç–æ —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∏ ‚Äî —Å–∏–ª—å–Ω–∞—è —à—Ç—É–∫–∞.",
        "–®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É ‚Äî –Ω–µ –ø—Ä–æ–≤–∞–ª. –≠—Ç–æ —á–∞—Å—Ç—å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏."
      ];
      function shouldShowSurprise(){
        const last = state.surprise?.lastShownAt ? new Date(state.surprise.lastShownAt).getTime() : 0;
        const sixHours = 6 * 60 * 60 * 1000;
        return (Date.now() - last) > sixHours && Math.random() < 0.35;
      }

      function dailySummaryText(){
        const d = dateKey();
        const { good, pause, total } = countFor(d);
        if(total === 0) return "–î–µ–Ω—å –ø—Ä–æ—à—ë–ª —Ç–∏—Ö–æ ‚Äî –±–µ–∑ –æ—Ç–º–µ—Ç–æ–∫.\n–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—Ç—Å—è, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ.";
        if(good > 0 && pause === 0) return "–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–µ–∑–Ω—ã—Ö —à–∞–≥–æ–≤.\n–ü—É—Å—Ç—å —ç—Ç–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–∞–∫ —Ç—ë–ø–ª–∞—è –æ–ø–æ—Ä–∞.";
        if(pause > 0 && good === 0) return "–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ –±–æ–ª—å—à–µ —à–∞–≥–æ–≤ –≤ —Å—Ç–æ—Ä–æ–Ω—É.\n–≠—Ç–æ –Ω–µ –ø—Ä–æ ¬´–ø–ª–æ—Ö–æ¬ª. –≠—Ç–æ –ø—Ä–æ —Ä–µ—Å—É—Ä—Å –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞.";
        if(good >= pause) return "–î–µ–Ω—å –ø–æ–ª—É—á–∏–ª—Å—è —Ä–∞–∑–Ω—ã–º.\n–ì–ª–∞–≤–Ω–æ–µ ‚Äî –º–æ–º–µ–Ω—Ç—ã –∑–∞–º–µ—á–µ–Ω—ã, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è.";
        return "–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ –Ω–µ–ø—Ä–æ—Å—Ç–æ, –Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç —Å —Å–æ–±–æ–π —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è.\n–≠—Ç–æ —É–∂–µ –º–Ω–æ–≥–æ.";
      }

      function lastNDays(n){
        const out = [];
        const base = new Date();
        for(let i=0;i<n;i++){
          const d = new Date(base);
          d.setDate(base.getDate()-i);
          out.push(dateKey(d));
        }
        return out.reverse();
      }
      function dayName(iso){
        const d = new Date(iso+"T00:00:00");
        const map = ["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"];
        return map[d.getDay()];
      }

      function weeklySummaryText(){
        const days = lastNDays(7);
        let g=0,p=0;
        days.forEach(d=>{
          const c=countFor(d);
          g+=c.good; p+=c.pause;
        });
        if(g+p===0) return "–ù–µ–¥–µ–ª—è –±—ã–ª–∞ –æ—á–µ–Ω—å —Ç–∏—Ö–æ–π.\n–ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –º–∞–ª–æ–≥–æ: –æ–¥–Ω–æ–π –æ—Ç–º–µ—Ç–∫–∏ –∏–ª–∏ –æ–¥–Ω–æ–π –º–∏–Ω—É—Ç—ã –¥—ã—Ö–∞–Ω–∏—è.";
        const line = g>=p
          ? "–ù–∞ –Ω–µ–¥–µ–ª–µ –±—ã–ª–æ –º–µ—Å—Ç–æ –∏ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è, –∏ –¥–ª—è —à–∞–≥–æ–≤ –≤ —Å—Ç–æ—Ä–æ–Ω—É. –≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∂–∏–≤–æ–π –±–∞–ª–∞–Ω—Å."
          : "–ù–∞ –Ω–µ–¥–µ–ª–µ –±—ã–ª–æ –±–æ–ª—å—à–µ —à–∞–≥–æ–≤ –≤ —Å—Ç–æ—Ä–æ–Ω—É. –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ–π—á–∞—Å –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –±–µ—Ä–µ—á—å —Ä–µ—Å—É—Ä—Å ‚Äî –∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.";
        return `–ü–æ–ª–µ–∑–Ω–æ–µ: ${g}\n–®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É: ${p}\n\n${line}`;
      }

      function aggregateTopics(events){
        const out = {};
        events.forEach(e=>{
          if(!e.topic) return;
          if(!out[e.topic]) out[e.topic] = { good:0, pause:0 };
          if(e.type === "good") out[e.topic].good += 1;
          else if(e.type === "pause") out[e.topic].pause += 1;
        });
        return out;
      }

      function renderTopicList(container, emptyEl, agg){
        const keys = Object.keys(agg);
        container.innerHTML = "";
        if(keys.length === 0){
          emptyEl.style.display = "block";
          return;
        }
        emptyEl.style.display = "none";

        keys.sort((a,b)=>{
          const A = agg[a], B = agg[b];
          const da = (A.pause - A.good);
          const db = (B.pause - B.good);
          if(db !== da) return db - da;
          return (B.good+B.pause) - (A.good+A.pause);
        });

        keys.forEach((k)=>{
          const v = agg[k];
          const delta = v.good - v.pause;

          const rowWrap = document.createElement("div");

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "topic-row";
          if(v.pause > v.good) btn.classList.add("pause");
          else if(v.good > v.pause) btn.classList.add("good");

          const left = document.createElement("div");
          left.className = "topic-left";
          left.innerHTML = `
            <div class="topic-title">${topicLabel(k)}</div>
            <div class="topic-sub">${v.pause > v.good ? "–æ–±–ª–∞—Å—Ç—å –≤–Ω–∏–º–∞–Ω–∏—è" : (v.good > v.pause ? "—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞" : "—Ä–æ–≤–Ω–æ")}</div>
          `;

          const pill = document.createElement("div");
          pill.className = "delta-pill";
          if(delta > 0) pill.classList.add("good");
          else if(delta < 0) pill.classList.add("pause");
          pill.textContent = delta > 0 ? `+${delta}` : `${delta}`;

          btn.appendChild(left);
          btn.appendChild(pill);

          const details = document.createElement("div");
          details.className = "topic-details";
          details.textContent = `–ü–æ–ª–µ–∑–Ω–æ–µ: ${v.good} ‚Ä¢ –®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É: ${v.pause}`;

          btn.addEventListener("click", () => details.classList.toggle("show"));

          rowWrap.appendChild(btn);
          rowWrap.appendChild(details);
          container.appendChild(rowWrap);
        });
      }

      function renderTopicsHint(agg){
        const entries = Object.entries(agg).map(([k,v])=>({ k, ...v, d:(v.pause - v.good), total:(v.good+v.pause) }));
        const focus = entries.filter(x=>x.d > 0).sort((a,b)=> b.d - a.d || b.total - a.total).slice(0,2);
        if(focus.length === 0) return "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—Ç—Å—è ‚Äî –∑–∞–≤—Ç—Ä–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 1 —Ç–µ–º—É, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å ¬´–∑–æ–Ω—ã –≤–Ω–∏–º–∞–Ω–∏—è¬ª —è—Å–Ω–µ–µ.";
        if(focus.length === 1) return `–°–µ–≥–æ–¥–Ω—è ¬´–ø—Ä–æ—Å–∏—Ç –≤–Ω–∏–º–∞–Ω–∏—è¬ª: ${topicLabel(focus[0].k)}. –ú–æ–∂–Ω–æ –º—è–≥–∫–æ: –æ–¥–∏–Ω –Ω–µ–±–æ–ª—å—à–æ–π —à–∞–≥ –∑–∞–≤—Ç—Ä–∞.`;
        return `–°–µ–≥–æ–¥–Ω—è ¬´–ø—Ä–æ—Å—è—Ç –≤–Ω–∏–º–∞–Ω–∏—è¬ª: ${topicLabel(focus[0].k)} –∏ ${topicLabel(focus[1].k)}. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω—É –∏ —Å–¥–µ–ª–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∑–∞–≤—Ç—Ä–∞.`;
      }

      function renderSummary(){
        const d = dateKey();
        $("#summaryDate").textContent = new Date().toLocaleDateString("ru-RU", { weekday:"long", day:"numeric", month:"long" });

        const note = (state.dayNotes && state.dayNotes[d]) ? String(state.dayNotes[d]).trim() : "";
        const noteEl = $("#summaryDayNote");
        if(note){
          noteEl.style.display = "block";
          noteEl.textContent = `–¢–µ–º–∞ –¥–Ω—è: ${note}`;
        }else{
          noteEl.style.display = "none";
          noteEl.textContent = "";
        }

        const c = countFor(d);
        $("#pillGood").textContent = `–ü–æ–ª–µ–∑–Ω–æ–µ: ${c.good}`;
        $("#pillPause").textContent = `–®–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É: ${c.pause}`;

        const row = $("#summaryDots");
        if(c.total===0) row.innerHTML = ""; else renderDots(row, c.ev, false);

        const box = $("#surpriseBox");
        if(shouldShowSurprise()){
          box.style.display = "block";
          box.textContent = pick(SURPRISE_LINES);
          state.surprise.lastShownAt = nowISO();
          save();
        }else{
          box.style.display = "none";
        }

        $("#dailyText").textContent = dailySummaryText();

        const aggToday = aggregateTopics(c.ev);
        renderTopicList($("#topicsToday"), $("#topicsTodayEmpty"), aggToday);
        $("#topicsHint").textContent = renderTopicsHint(aggToday);

        const grid = $("#weekGrid");
        grid.innerHTML = "";
        lastNDays(7).forEach(dd=>{
          const cc = countFor(dd);
          const item = document.createElement("div");
          item.className = "p-3";
          item.style.border = "1px solid var(--stroke)";
          item.style.borderRadius = "16px";
          item.style.background = (document.documentElement.getAttribute("data-theme")==="dark")
            ? "rgba(255,255,255,0.06)"
            : "rgba(255,255,255,0.55)";

          const header = document.createElement("div");
          header.className = "flex items-center justify-between mb-2";
          header.innerHTML = `<div style="font-weight:650; letter-spacing:-0.02em;">${dayName(dd)}</div><div class="small-muted">${cc.good}/${cc.pause}</div>`;

          const dots = document.createElement("div");
          dots.className = "dot-row";
          if(cc.total>0){
            cc.ev.slice(-24).forEach(e=>{
              const dot = document.createElement("div");
              dot.className = "dot " + (e.type==="good" ? "good" : "pause");
              dots.appendChild(dot);
            });
          }else{
            const t=document.createElement("div");
            t.className="small-muted";
            t.textContent="‚Äî";
            dots.appendChild(t);
          }

          item.appendChild(header);
          item.appendChild(dots);
          grid.appendChild(item);
        });

        $("#weeklyText").textContent = weeklySummaryText();

        const weekEvents = lastNDays(7).flatMap(dd => countFor(dd).ev);
        const aggWeek = aggregateTopics(weekEvents);
        renderTopicList($("#topicsWeek"), $("#topicsWeekEmpty"), aggWeek);
      }

      function openDayNote(){
        const d = dateKey();
        const wrap = $("#dayNoteWrap");
        const input = $("#dayNoteInput");
        wrap.classList.add("show");
        input.value = (state.dayNotes && state.dayNotes[d]) ? String(state.dayNotes[d]) : "";
        setTimeout(() => input.focus(), 0);
      }
      function closeDayNote(){ $("#dayNoteWrap").classList.remove("show"); }
      function saveDayNote(){
        const d = dateKey();
        const val = ($("#dayNoteInput").value || "").trim();
        if(!state.dayNotes) state.dayNotes = {};
        if(val){
          state.dayNotes[d] = val;
          toast("‚úì –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
          haptic("success");
        }else{
          delete state.dayNotes[d];
          toast("–ó–∞–º–µ—Ç–∫–∞ –æ—á–∏—â–µ–Ω–∞");
          haptic("light");
        }
        save();
        renderToday();
        if(currentTab === "summary") renderSummary();
      }

      const breathCircle = $("#breathCircle");
      const breathLabel  = $("#breathLabel");
      const breathSub    = $("#breathSub");
      const breathToggle = $("#breathToggle");

      let breathTimer = null;
      let breathElapsed = 0;
      let phaseIndex = 0;
      let secondInPhase = 0;
      let running = false;

      const PHASES = [
        { label:"–í–¥–æ—Ö",  dur:4, from:0.78, to:1.00 },
        { label:"–ü–∞—É–∑–∞", dur:4, from:1.00, to:1.00 },
        { label:"–í—ã–¥–æ—Ö", dur:4, from:1.00, to:0.78 },
        { label:"–ü–∞—É–∑–∞", dur:4, from:0.78, to:0.78 }
      ];

      function setScale(scale, smooth=true, seconds=1){
        breathCircle.style.transition = smooth ? `transform ${seconds}s linear` : "none";
        breathCircle.style.transform = `translateZ(0) scale(${scale})`;
      }

      function countString(n){
        const base = ["1","2","3","4"];
        return base.slice(0, Math.max(1, Math.min(4,n))).join("-");
      }

      function runPhase(i){
        const phase = PHASES[i];
        phaseIndex = i;
        secondInPhase = 0;

        breathLabel.textContent = phase.label;
        breathSub.textContent = `${phase.label} ${countString(1)}`;

        setScale(phase.from, false);

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            setScale(phase.to, true, phase.dur);
          });
        });
      }

      function startBreathing(){
        stopBreathing(false);

        running = true;
        breathElapsed = 0;
        breathToggle.textContent = "–°—Ç–æ–ø";

        runPhase(0);

        breathTimer = setInterval(() => {
          breathElapsed++;

          const phase = PHASES[phaseIndex];

          secondInPhase++;
          if(secondInPhase < phase.dur){
            breathSub.textContent = `${phase.label} ${countString(secondInPhase+1)}`;
          }else{
            const next = (phaseIndex + 1) % PHASES.length;
            runPhase(next);
          }

          if(breathElapsed >= 60){
            stopBreathing(true);
          }
        }, 1000);
      }

      function stopBreathing(auto){
        if(breathTimer){
          clearInterval(breathTimer);
          breathTimer = null;
        }
        running = false;

        breathToggle.textContent = "–ù–∞—á–∞—Ç—å";
        breathLabel.textContent = "–ì–æ—Ç–æ–≤–æ";
        breathSub.textContent = auto
          ? "–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –ø—Ä–æ—Å—Ç–æ –ø–æ–±—ã—Ç—å –≤ —ç—Ç–æ–º –æ—â—É—â–µ–Ω–∏–∏."
          : "–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª –∏ –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É–π —Å—á—ë—Ç—É.";

        setScale(0.78, true, 0.6);

        if(auto){
          toast("‚úì 1 –º–∏–Ω—É—Ç–∞");
          haptic("success");
        }
      }

      function confirmCustomTopic(){
        const label = normalizeCustomLabel($("#customTopicInput").value);
        if(!label){
          toast("–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ üôÇ");
          return;
        }
        const id = addCustomTopic(label);
        if(!id) return;

        selectedTopic = id;
        showCustomTopicInput(false);

        const chip = $$("#topicChips .chip").find(x => x.dataset.topic === selectedTopic);
        if(chip) flashChip(chip);

        autosavePendingEventTopic(selectedTopic);
        toast("‚úì –¢–µ–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
        haptic("success");
        setTimeout(() => closeNoteModal(), 160);
      }

      function wire(){
        $("#btnGood").addEventListener("click", () => addEvent("good"));
        $("#btnPause").addEventListener("click", () => addEvent("pause"));
        $("#btnClearToday").addEventListener("click", clearToday);

        $("#btnDayNote").addEventListener("click", () => {
          const wrap = $("#dayNoteWrap");
          if(wrap.classList.contains("show")) closeDayNote();
          else openDayNote();
        });
        $("#dayNoteClose").addEventListener("click", () => {
          closeDayNote();
          saveDayNote();
        });
        $("#dayNoteInput").addEventListener("blur", saveDayNote);
        $("#dayNoteInput").addEventListener("keydown", (e) => {
          if(e.key === "Enter"){
            e.preventDefault();
            saveDayNote();
            closeDayNote();
          }
        });

        $("#customTopicOk").addEventListener("click", confirmCustomTopic);
        $("#customTopicCancel").addEventListener("click", () => showCustomTopicInput(false));
        $("#customTopicInput").addEventListener("keydown", (e) => {
          if(e.key === "Enter"){
            e.preventDefault();
            confirmCustomTopic();
          }
        });

        breathToggle.addEventListener("click", () => running ? stopBreathing(false) : startBreathing());

        $$("#tab-settings [data-theme]").forEach(btn=>{
          btn.addEventListener("click", () => {
            state.theme = btn.dataset.theme;
            save();
            applyTheme();
            toast("–¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
          });
        });

        $("#btnExport").addEventListener("click", () => {
          const box = $("#exportBox");
          box.classList.remove("hidden");
          box.textContent = JSON.stringify(state, null, 2);
          navigator.clipboard?.writeText(box.textContent).catch(()=>{});
          toast("–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
          haptic("success");
        });

        $("#btnReset").addEventListener("click", () => {
          const ok = confirm("–°—Ç–µ—Ä–µ—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ?");
          if(!ok) return;
          state = defaultState();
          save();
          $("#exportBox").classList.add("hidden");
          renderToday();
          ensureMicrocopyForToday();
          setDebug(null);
          toast("–ì–æ—Ç–æ–≤–æ. –ß–∏—Å—Ç—ã–π –ª–∏—Å—Ç");
          haptic("light");
        });

        $("#noteBackdrop").addEventListener("click", closeNoteModal);
        $("#noteClose").addEventListener("click", closeNoteModal);

        window.addEventListener("keydown", (e) => {
          if(e.key === "Escape"){
            if($("#noteModal").classList.contains("show")) closeNoteModal();
            closeDayNote();
            clearAllDeleteModes();
          }
        });

        installDeleteModeAutoClose();
      }

      function flashChip(el){
        el.classList.remove("flash");
        void el.offsetWidth;
        el.classList.add("flash");
        setTimeout(() => el.classList.remove("flash"), 220);
      }

      // Boot
      function boot(){
        ensureEventIds();
        applyTheme();
        renderToday();
        ensureMicrocopyForToday();
        setDebug(state.debug?.lastError || null);
        wire();
        setTab("today");
      }

      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", boot);
      }else{
        boot();
      }
    })();
  </script>
</body>
</html>
