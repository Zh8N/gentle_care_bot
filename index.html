<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Balance Care</title>

  <!-- Tailwind (удобно, можно потом убрать) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      /* Light */
      --bg: #f6f7fb;
      --card: rgba(255,255,255,0.92);
      --card2: rgba(255,255,255,0.78);
      --stroke: rgba(15,23,42,0.10);
      --text: rgba(15,23,42,0.92);
      --muted: rgba(15,23,42,0.62);

      /* Primary palette (синий + серый) */
      --primary: #2563eb;      /* blue-600 */
      --primary2:#1d4ed8;      /* blue-700 */
      --neutral: #e8ecf4;      /* soft gray */
      --neutralText: rgba(15,23,42,0.82);

      --shadow: 0 14px 40px rgba(15,23,42,0.10);
      --radius: 22px;
    }

    html[data-theme="dark"]{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);

      --neutral: rgba(255,255,255,0.08);
      --neutralText: rgba(255,255,255,0.88);

      --shadow: 0 18px 50px rgba(0,0,0,0.35);
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(37,99,235,0.10), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(29,78,216,0.10), transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    .app-wrap{
      padding-top: calc(14px + var(--safe-top));
      padding-bottom: calc(18px + var(--safe-bottom));
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .segmented{
      background: rgba(255,255,255,0.55);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 6px;
      display:flex;
      gap: 6px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    html[data-theme="dark"] .segmented{
      background: rgba(255,255,255,0.06);
    }

    .tab-btn{
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
      border: 1px solid transparent;
      color: var(--muted);
      background: transparent;
      transition: transform .06s ease, background .18s ease, color .18s ease, border-color .18s ease;
      user-select: none;
      -webkit-user-select: none;
    }
    .tab-btn:active{ transform: scale(0.99); }

    .tab-btn.active{
      color: white;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-color: rgba(255,255,255,0.18);
      box-shadow: 0 10px 26px rgba(37,99,235,0.22);
    }

    .action-btn{
      width: 100%;
      border-radius: 20px;
      padding: 18px 16px;
      font-size: 18px;
      font-weight: 650;
      border: 1px solid var(--stroke);
      transition: transform .06s ease, filter .08s ease;
      user-select: none;
      -webkit-user-select: none;
    }
    .action-btn:active{ transform: translateY(1px); filter: brightness(0.98); }

    .action-primary{
      color: white;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-color: rgba(255,255,255,0.18);
      box-shadow: 0 14px 34px rgba(37,99,235,0.26);
    }

    .action-neutral{
      color: var(--neutralText);
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.45));
    }
    html[data-theme="dark"] .action-neutral{
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
    }

    .dot-row{ display:flex; gap:8px; flex-wrap: wrap; padding-top: 6px; }
    .dot{
      width: 16px; height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 8px 20px rgba(15,23,42,0.06);
    }
    html[data-theme="dark"] .dot{
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 8px 20px rgba(0,0,0,0.22);
    }
    .dot.good{ background: var(--primary); }
    .dot.pause{ background: rgba(148,163,184,0.95); } /* slate-ish */
    html[data-theme="dark"] .dot.pause{ background: rgba(203,213,225,0.55); }

    .small-muted{ color: var(--muted); font-size: 13px; line-height: 1.35; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      font-size: 13px;
      color: var(--muted);
    }
    html[data-theme="dark"] .pill{ background: rgba(255,255,255,0.06); }

    .surprise{
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px dashed rgba(37,99,235,0.28);
      background: radial-gradient(900px 260px at 20% 0%, rgba(37,99,235,0.10), transparent 55%),
                  rgba(255,255,255,0.55);
      color: rgba(15,23,42,0.82);
    }
    html[data-theme="dark"] .surprise{
      background: radial-gradient(900px 260px at 20% 0%, rgba(37,99,235,0.18), transparent 55%),
                  rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.86);
      border-color: rgba(37,99,235,0.28);
    }

    /* Breathing circle */
    .breath-wrap{
      display:flex; flex-direction:column; align-items:center; gap: 12px;
      padding: 10px 0 2px;
    }

    /* IMPORTANT: force perfect circle even in Telegram WebView */
    .breath-circle{
      position: relative;
      width: 190px; height: 190px;

      border-radius: 50%;
      overflow: hidden;

      -webkit-mask-image: -webkit-radial-gradient(white, black);
      mask-image: radial-gradient(white, black);

      clip-path: circle(50% at 50% 50%);
      -webkit-clip-path: circle(50% at 50% 50%);

      display:flex; align-items:center; justify-content:center;
      color: white;
      font-weight: 700;
      letter-spacing: -0.02em;

      transform: translateZ(0) scale(0.78);
      will-change: transform;
      backface-visibility: hidden;

      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 22px 60px rgba(37,99,235,0.18);
      user-select:none;
      -webkit-user-select:none;
    }

    .breath-circle::before{
      content:"";
      position:absolute;
      inset:-40px;

      border-radius: 50%;
      clip-path: circle(50% at 50% 50%);
      -webkit-clip-path: circle(50% at 50% 50%);

      background: conic-gradient(from 180deg,
        rgba(37,99,235,1),
        rgba(29,78,216,1),
        rgba(124,58,237,1),
        rgba(37,99,235,1)
      );

      animation: spin 10s linear infinite;
      opacity: 0.95;
      transform: translateZ(0);
    }

    .breath-circle::after{
      content:"";
      position:absolute;
      inset:0;

      border-radius: 50%;
      clip-path: circle(50% at 50% 50%);
      -webkit-clip-path: circle(50% at 50% 50%);

      background: radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,0.28), transparent 60%),
                  rgba(0,0,0,0.10);
      mix-blend-mode: soft-light;
      transform: translateZ(0);
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .breath-circle > span{
      position: relative;
      z-index: 2;
      text-align:center;
      padding: 0 12px;
    }

    .breath-sub{
      font-size: 14px;
      color: var(--muted);
      text-align:center;
    }

    .ghost-btn{
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      color: var(--text);
      font-size: 14px;
      transition: transform .06s ease, background .16s ease;
      user-select:none; -webkit-user-select:none;
    }
    html[data-theme="dark"] .ghost-btn{ background: rgba(255,255,255,0.06); }
    .ghost-btn:active{ transform: translateY(1px); }

    /* Export box theme */
    .export-box{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,0.55);
      padding: 12px 14px;
    }
    html[data-theme="dark"] .export-box{ background: rgba(255,255,255,0.06); }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-bottom));
      z-index: 50;
      width: min(92vw, 420px);
      display:none;
    }
    .toast.show{ display:block; }
    .toast .inner{
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.75);
      box-shadow: 0 18px 50px rgba(15,23,42,0.12);
      color: rgba(15,23,42,0.88);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-size: 14px;
    }
    html[data-theme="dark"] .toast .inner{
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.90);
      box-shadow: 0 18px 50px rgba(0,0,0,0.38);
    }
  </style>
</head>

<body>
  <div class="app-wrap max-w-md mx-auto px-4">
    <!-- Tabs -->
    <div class="segmented card p-0 mb-4" style="box-shadow:none;">
      <button class="tab-btn active" data-tab="today">Сегодня</button>
      <button class="tab-btn" data-tab="summary">Итоги</button>
      <button class="tab-btn" data-tab="breath">Дыхание</button>
      <button class="tab-btn" data-tab="settings">Настройки</button>
    </div>

    <!-- TODAY -->
    <section id="tab-today" class="fade">
      <div class="card p-4 mb-4">
        <div>
          <div class="text-base font-semibold" style="letter-spacing:-0.02em;">Отметить момент</div>
          <div class="small-muted" id="todayMicrocopy">Без оценок. Просто фиксируем — и становится яснее.</div>
        </div>
      </div>

      <div class="grid gap-3 mb-4">
        <button id="btnGood" class="action-btn action-primary">Сделала полезное</button>
        <button id="btnPause" class="action-btn action-neutral">Сделала паузу</button>
      </div>

      <div class="card p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">Сегодня</div>
          <button id="btnClearToday" class="ghost-btn" style="padding:8px 10px; font-size:13px;">Очистить</button>
        </div>
        <div id="todayDots" class="dot-row"></div>
        <div id="todayEmpty" class="small-muted mt-2" style="display:none;">
          Пока здесь пусто — и это тоже нормально.
        </div>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="tab-summary" class="hidden fade">
      <div class="card p-4 mb-4">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-base font-semibold" style="letter-spacing:-0.02em;">Итоги дня</div>
            <div class="small-muted" id="summaryDate"></div>
          </div>
        </div>

        <div class="flex items-center gap-2 mb-3">
          <span class="pill" id="pillGood">Полезное: 0</span>
          <span class="pill" id="pillPause">Пауза: 0</span>
        </div>

        <div id="summaryDots" class="dot-row mb-3"></div>

        <div id="surpriseBox" class="surprise" style="display:none;"></div>

        <div class="mt-3 small-muted whitespace-pre-wrap" id="dailyText"></div>
      </div>

      <div class="card p-4">
        <div class="text-base font-semibold mb-1" style="letter-spacing:-0.02em;">Неделя</div>
        <div class="small-muted mb-3">Семь дней — одна линия наблюдений.</div>

        <div id="weekGrid" class="grid gap-2"></div>

        <div class="mt-3 small-muted whitespace-pre-wrap" id="weeklyText"></div>
      </div>
    </section>

    <!-- BREATH -->
    <section id="tab-breath" class="hidden fade">
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-base font-semibold" style="letter-spacing:-0.02em;">1 минута</div>
            <div class="small-muted">Дыхание 4 • 4 • 4 • 4</div>
          </div>
          <button id="breathToggle" class="ghost-btn">Начать</button>
        </div>

        <div class="breath-wrap">
          <div id="breathCircle" class="breath-circle" aria-label="дыхание">
            <span id="breathLabel">Готово</span>
          </div>
          <div class="breath-sub" id="breathSub">Нажми «Начать» и просто следуй счёту.</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="hidden fade">
      <div class="card p-4 mb-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">Тема</div>
        <div class="segmented" style="box-shadow:none;">
          <button class="tab-btn" data-theme="light" id="themeLight">☀︎ Светлая</button>
          <button class="tab-btn" data-theme="dark" id="themeDark">☾ Тёмная</button>
          <button class="tab-btn" data-theme="system" id="themeSystem">◯ Системная</button>
        </div>
        <div class="small-muted mt-2">Можно оставить «Системная» — будет подстраиваться.</div>
      </div>

      <div class="card p-4 mb-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">О приложении</div>
        <div class="small-muted whitespace-pre-wrap">
Это мини-пространство для наблюдений.
В течение дня ты отмечаешь маленькие шаги: «полезное» или «пауза».
К концу дня складывается картина, а потом — неделя.
Из таких маленьких отметок становится проще понять, что ведёт к результатам — мягко, без давления.
        </div>
      </div>

      <div class="card p-4">
        <div class="text-base font-semibold mb-2" style="letter-spacing:-0.02em;">Данные</div>
        <div class="small-muted">Если захочешь начать с чистого листа — можно стереть локальную историю.</div>
        <div class="mt-3 flex gap-2">
          <button id="btnExport" class="ghost-btn flex-1">Экспорт</button>
          <button id="btnReset" class="ghost-btn flex-1" style="border-color: rgba(37,99,235,0.25);">Стереть</button>
        </div>
        <pre id="exportBox" class="mt-3 hidden export-box small-muted whitespace-pre-wrap"></pre>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <div class="inner" id="toastInner">✓ Записано</div>
  </div>

  <script>
    ;(() => {
      // -----------------------------
      // Telegram
      // -----------------------------
      const tg = window.Telegram?.WebApp || null;
      try{
        tg?.ready?.();
        tg?.expand?.();
      }catch(e){}

      // -----------------------------
      // Storage
      // -----------------------------
      const STORAGE = "balancecare_v5";
      const defaultState = () => ({
        theme: "system",
        events: [],  // {ts, date, type: "good"|"pause"}
        surprise: { lastShownAt: null },
        ui: { microcopyDate: null, microcopyText: null }
      });

      let state = loadState();

      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE);
          if(!raw) return defaultState();
          const parsed = JSON.parse(raw);
          return { ...defaultState(), ...parsed, ui: { ...defaultState().ui, ...(parsed.ui||{}) } };
        }catch(e){
          return defaultState();
        }
      }
      function save(){
        localStorage.setItem(STORAGE, JSON.stringify(state));
      }

      // Local date key (без UTC-сдвигов)
      function pad(n){ return String(n).padStart(2,"0"); }
      function dateKey(d=new Date()){
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }
      function nowISO(){ return new Date().toISOString(); }

      // -----------------------------
      // Theme
      // -----------------------------
      let systemListenerAttached = false;

      function isLight(hex){
        try{
          const h = hex.replace("#","").trim();
          const full = h.length === 3 ? h.split("").map(x=>x+x).join("") : h;
          const n = parseInt(full,16);
          const r=(n>>16)&255, g=(n>>8)&255, b=n&255;
          const lum = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
          return lum > 0.6;
        }catch(e){ return true; }
      }

      function applyTheme(){
        if(state.theme === "light"){
          document.documentElement.setAttribute("data-theme","light");
        }else if(state.theme === "dark"){
          document.documentElement.setAttribute("data-theme","dark");
        }else{
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          document.documentElement.setAttribute("data-theme", prefersDark ? "dark" : "light");

          if(!systemListenerAttached && window.matchMedia){
            systemListenerAttached = true;
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
              if(state.theme === "system") applyTheme();
            });
          }
        }

        // Telegram theme hint (only if system)
        try{
          const tp = tg?.themeParams || {};
          const bg = tp.bg_color;
          if(state.theme === "system" && bg){
            document.documentElement.setAttribute("data-theme", isLight(bg) ? "light" : "dark");
          }
        }catch(e){}

        renderThemeButtons();
      }

      function renderThemeButtons(){
        const map = { light:"themeLight", dark:"themeDark", system:"themeSystem" };
        ["themeLight","themeDark","themeSystem"].forEach(id => {
          const el = document.getElementById(id);
          el.classList.remove("active");
          el.style.background = "transparent";
          el.style.color = "var(--muted)";
        });

        const activeId = map[state.theme] || "themeSystem";
        const activeEl = document.getElementById(activeId);
        activeEl.classList.add("active");
        activeEl.style.background = "linear-gradient(180deg, var(--primary), var(--primary2))";
        activeEl.style.color = "white";
      }

      // -----------------------------
      // UI helpers
      // -----------------------------
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      function toast(msg){
        const t = $("#toast");
        $("#toastInner").textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._t);
        toast._t = setTimeout(() => t.classList.remove("show"), 1400);
      }

      function haptic(kind="light"){
        try{
          if(tg?.HapticFeedback){
            if(kind==="success") tg.HapticFeedback.notificationOccurred("success");
            else tg.HapticFeedback.impactOccurred("light");
          }
        }catch(e){}
      }

      function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

      // -----------------------------
      // Microcopy of the day (soft friend, motivating)
      // -----------------------------
      const MICROCOPY = [
        "Мы ничего не оцениваем. Мы просто замечаем — и от этого легче.",
        "Один маленький шаг тоже считается. Правда.",
        "Ты можешь идти медленно. Главное — в свою сторону.",
        "Нежно фиксируем — и внутри становится чуть тише.",
        "Сейчас достаточно одной отметки. Остальное — потом.",
        "Ты не обязана быть идеальной, чтобы двигаться вперёд.",
        "Если хочешь — просто отметь. Это уже забота о себе.",
        "Шаг за шагом. Не героически — по-человечески.",
        "Ты уже здесь. Это хорошее место начать.",
        "Маленькая ясность сегодня — большой подарок завтра.",
        "Не нужно «правильно». Нужно бережно и честно.",
        "Даже пауза — это действие. Ты заметила её.",
        "Я с тобой. Давай просто посмотрим, как оно есть.",
        "Твоё «чуть-чуть» сегодня — всё равно движение.",
        "Иногда самое сильное — это не ускориться, а остановиться вовремя.",
        "Пусть это будет твоей тихой опорой на день.",
        "Мы собираем не рекорды, а реальность. И это очень ценно."
      ];

      function ensureMicrocopyForToday(){
        const d = dateKey();
        state.ui = state.ui || {};
        if(state.ui.microcopyDate !== d || !state.ui.microcopyText){
          state.ui.microcopyDate = d;
          state.ui.microcopyText = pick(MICROCOPY);
          save();
        }
        const el = $("#todayMicrocopy");
        if(el) el.textContent = state.ui.microcopyText;
      }

      // -----------------------------
      // Tabs
      // -----------------------------
      let currentTab = "today";

      function setTab(name){
        currentTab = name;

        $$(".tab-btn[data-tab]").forEach(btn => {
          btn.classList.toggle("active", btn.dataset.tab === name);
        });

        ["today","summary","breath","settings"].forEach(t => {
          $("#tab-"+t).classList.toggle("hidden", t !== name);
        });

        if(name === "today") ensureMicrocopyForToday();
        if(name === "summary") renderSummary();
        if(name !== "breath") stopBreathing();
      }

      $$(".tab-btn[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => setTab(btn.dataset.tab));
      });

      // -----------------------------
      // Data ops
      // -----------------------------
      function addEvent(type){
        state.events.push({ ts: nowISO(), date: dateKey(), type });
        save();
        renderToday();
        if(currentTab === "summary") renderSummary();

        toast("✓ Записано");
        haptic("success");
      }

      function clearToday(){
        const d = dateKey();
        state.events = state.events.filter(e => e.date !== d);
        save();
        renderToday();
        if(currentTab === "summary") renderSummary();

        toast("Очищено");
        haptic("light");
      }

      function eventsFor(d){
        return state.events.filter(e => e.date === d);
      }

      function countFor(d){
        const ev = eventsFor(d);
        const good = ev.filter(x => x.type === "good").length;
        const pause = ev.filter(x => x.type === "pause").length;
        return { good, pause, total: ev.length, ev };
      }

      // -----------------------------
      // Today render
      // -----------------------------
      function renderDots(container, ev){
        container.innerHTML = "";
        ev.slice(-48).forEach(e => {
          const dot = document.createElement("div");
          dot.className = "dot " + (e.type === "good" ? "good" : "pause");
          container.appendChild(dot);
        });
      }

      function renderToday(){
        const d = dateKey();
        const { ev, total } = countFor(d);

        const row = $("#todayDots");
        const empty = $("#todayEmpty");

        if(total === 0){
          row.innerHTML = "";
          empty.style.display = "block";
        }else{
          empty.style.display = "none";
          renderDots(row, ev);
        }
      }

      // -----------------------------
      // Surprise observations (rare, warm)
      // -----------------------------
      const SURPRISE_LINES = [
        "Мне нравится, как ты это делаешь: спокойно и по-честному.",
        "Ты заметила момент — и уже стала к себе ближе.",
        "Пусть это будет маленьким «я с собой» в середине дня.",
        "Ты не одна: я тут, рядом, на твоей стороне.",
        "Смотри, ты реально движешься. Даже если шаги маленькие.",
        "Сегодня ты выбрала себя хотя бы раз — и это уже много.",
        "Иногда самое мудрое — дать себе паузу. Ты умеешь.",
        "Нежность тоже дисциплина. Ты её практикуешь.",
        "Ты не обязана доказывать. Можно просто жить и замечать."
      ];

      function shouldShowSurprise(){
        const last = state.surprise?.lastShownAt ? new Date(state.surprise.lastShownAt).getTime() : 0;
        const sixHours = 6 * 60 * 60 * 1000;
        const okByTime = (Date.now() - last) > sixHours;
        const chance = Math.random() < 0.35;
        return okByTime && chance;
      }

      // -----------------------------
      // Summary text (soft friend, motivating)
      // -----------------------------
      function dailySummaryText(){
        const d = dateKey();
        const { good, pause, total } = countFor(d);

        if(total === 0){
          return "Сегодня было тихо — без отметок.\nЕсли захочешь, вернёшься позже. Я рядом.";
        }

        if(good > 0 && pause === 0){
          return "Сегодня ты несколько раз выбрала полезное.\nПусть это останется внутри как тёплая уверенность: ты можешь.";
        }

        if(pause > 0 && good === 0){
          return "Сегодня было больше пауз.\nЭто не про «плохо». Это про заботу: ты заметила, где нужен воздух.";
        }

        if(good >= pause){
          return "День получился разным — и в этом есть жизнь.\nТы уже делаешь главное: замечаешь и не давишь на себя.";
        }

        return "Сегодня было непросто, но ты всё равно осталась с собой в контакте.\nЭто очень сильная, взрослая опора.";
      }

      function lastNDays(n){
        const out = [];
        const base = new Date();
        for(let i=0;i<n;i++){
          const d = new Date(base);
          d.setDate(base.getDate()-i);
          out.push(dateKey(d));
        }
        return out.reverse();
      }

      function dayName(iso){
        const d = new Date(iso+"T00:00:00");
        const map = ["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];
        return map[d.getDay()];
      }

      function weeklySummaryText(){
        const days = lastNDays(7);
        let g=0,p=0;
        days.forEach(d=>{
          const c=countFor(d);
          g+=c.good; p+=c.pause;
        });

        if(g+p===0){
          return "Неделя была очень тихой.\nЕсли это про усталость — можно начать с малого: одной отметки или одной минуты дыхания.";
        }

        const line =
          g>=p
            ? "В этой неделе было место и для движения, и для пауз. Это похоже на живой баланс."
            : "В этой неделе было больше пауз. Возможно, тебе сейчас особенно важно беречь ресурс — и это нормально.";

        return `Полезное: ${g}\nПауза: ${p}\n\n${line}`;
      }

      function renderSummary(){
        $("#summaryDate").textContent = new Date().toLocaleDateString("ru-RU", {
          weekday:"long", day:"numeric", month:"long"
        });

        const d = dateKey();
        const c = countFor(d);

        $("#pillGood").textContent = `Полезное: ${c.good}`;
        $("#pillPause").textContent = `Пауза: ${c.pause}`;

        const row = $("#summaryDots");
        if(c.total===0){
          row.innerHTML = "";
        }else{
          renderDots(row, c.ev);
        }

        const box = $("#surpriseBox");
        if(shouldShowSurprise()){
          box.style.display = "block";
          box.textContent = pick(SURPRISE_LINES);
          state.surprise.lastShownAt = nowISO();
          save();
        }else{
          box.style.display = "none";
        }

        $("#dailyText").textContent = dailySummaryText();

        const grid = $("#weekGrid");
        grid.innerHTML = "";
        const days = lastNDays(7);
        days.forEach(dd=>{
          const cc = countFor(dd);
          const item = document.createElement("div");
          item.className = "p-3";
          item.style.border = "1px solid var(--stroke)";
          item.style.borderRadius = "16px";
          item.style.background = (document.documentElement.getAttribute("data-theme")==="dark")
            ? "rgba(255,255,255,0.06)"
            : "rgba(255,255,255,0.55)";

          const header = document.createElement("div");
          header.className = "flex items-center justify-between mb-2";
          header.innerHTML = `
            <div style="font-weight:650; letter-spacing:-0.02em;">${dayName(dd)}</div>
            <div class="small-muted">${cc.good}/${cc.pause}</div>
          `;

          const dots = document.createElement("div");
          dots.className = "dot-row";
          if(cc.total>0){
            cc.ev.slice(-24).forEach(e=>{
              const dot = document.createElement("div");
              dot.className = "dot " + (e.type==="good" ? "good" : "pause");
              dots.appendChild(dot);
            });
          }else{
            const t=document.createElement("div");
            t.className="small-muted";
            t.textContent="—";
            dots.appendChild(t);
          }

          item.appendChild(header);
          item.appendChild(dots);
          grid.appendChild(item);
        });

        $("#weeklyText").textContent = weeklySummaryText();
      }

      // -----------------------------
      // Breathing (4–4–4–4, 1 minute) — correct cycle
      // -----------------------------
      const breathCircle = $("#breathCircle");
      const breathLabel  = $("#breathLabel");
      const breathSub    = $("#breathSub");
      const breathToggle = $("#breathToggle");

      let breathTimer = null;
      let breathElapsed = 0;
      let phaseIndex = 0;
      let secondInPhase = 0;
      let running = false;

      const PHASES = [
        { label:"Вдох",  dur:4, from:0.78, to:1.00 },
        { label:"Пауза", dur:4, from:1.00, to:1.00 },
        { label:"Выдох", dur:4, from:1.00, to:0.78 },
        { label:"Пауза", dur:4, from:0.78, to:0.78 }
      ];

      function setScale(scale, smooth=true, seconds=1){
        breathCircle.style.transition = smooth ? `transform ${seconds}s linear` : "none";
        breathCircle.style.transform = `translateZ(0) scale(${scale})`;
      }

      function countString(n){
        const arr = [];
        for(let i=1;i<=n;i++) arr.push(String(i));
        return arr.join("-");
      }

      function startBreathing(){
        stopBreathing();

        running = true;
        breathElapsed = 0;
        phaseIndex = 0;
        secondInPhase = 0;

        breathToggle.textContent = "Стоп";

        // init
        setScale(PHASES[0].from, false);
        breathLabel.textContent = PHASES[0].label;
        breathSub.textContent = `${PHASES[0].label} ${countString(1)}`;

        // start first phase animation for full 4s
        requestAnimationFrame(() => setScale(PHASES[0].to, true, PHASES[0].dur));

        breathTimer = setInterval(() => {
          breathElapsed++;

          const phase = PHASES[phaseIndex];
          const step = secondInPhase + 1;

          breathLabel.textContent = phase.label;
          breathSub.textContent = `${phase.label} ${countString(step)}${step < 4 ? "" : ""}`;

          // on phase start, trigger smooth animation for full phase duration
          if(secondInPhase === 0){
            setScale(phase.from, false);
            requestAnimationFrame(() => setScale(phase.to, true, phase.dur));
          }

          secondInPhase++;

          if(secondInPhase >= phase.dur){
            secondInPhase = 0;
            phaseIndex = (phaseIndex + 1) % PHASES.length;
          }

          // auto stop at 60 sec
          if(breathElapsed >= 60){
            stopBreathing(true);
          }
        }, 1000);
      }

      function stopBreathing(auto=false){
        if(breathTimer){
          clearInterval(breathTimer);
          breathTimer = null;
        }
        running = false;
        breathToggle.textContent = "Начать";
        breathLabel.textContent = "Готово";
        breathSub.textContent = auto
          ? "Хорошо. Можно просто заметить это ощущение."
          : "Нажми «Начать» и просто следуй счёту.";
        setScale(0.78, true, 0.6);
        if(auto){ toast("✓ 1 минута"); haptic("success"); }
      }

      breathToggle.addEventListener("click", () => {
        if(running) stopBreathing(false);
        else startBreathing();
      });

      // -----------------------------
      // Settings actions
      // -----------------------------
      $$("#tab-settings [data-theme]").forEach(btn=>{
        btn.addEventListener("click", () => {
          state.theme = btn.dataset.theme;
          save();
          applyTheme();
          toast("Тема сохранена");
        });
      });

      $("#btnExport").addEventListener("click", () => {
        const box = $("#exportBox");
        box.classList.remove("hidden");
        box.textContent = JSON.stringify(state, null, 2);
        navigator.clipboard?.writeText(box.textContent).catch(()=>{});
        toast("Экспорт скопирован");
        haptic("success");
      });

      $("#btnReset").addEventListener("click", () => {
        const ok = confirm("Стереть всю историю на этом устройстве?");
        if(!ok) return;
        state = defaultState();
        save();
        $("#exportBox").classList.add("hidden");
        renderToday();
        if(currentTab==="summary") renderSummary();
        ensureMicrocopyForToday();
        toast("Готово. Чистый лист");
        haptic("light");
      });

      // -----------------------------
      // Wire buttons
      // -----------------------------
      $("#btnGood").addEventListener("click", () => addEvent("good"));
      $("#btnPause").addEventListener("click", () => addEvent("pause"));
      $("#btnClearToday").addEventListener("click", clearToday);

      // -----------------------------
      // Init
      // -----------------------------
      applyTheme();
      renderToday();
      ensureMicrocopyForToday();
      setTab("today");
    })();
  </script>
</body>
</html>
