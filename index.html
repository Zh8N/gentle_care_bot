<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Balance Care</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      /* Palette (–º—è–≥–∫–∞—è, –Ω–æ –∑–∞–º–µ—Ç–Ω–∞—è) */
      --bg: #F6F7F7;
      --card: #FFFFFF;
      --text: #121316;
      --muted: rgba(18,19,22,.58);
      --line: rgba(18,19,22,.10);

      /* Main actions */
      --good: #2FBF71;          /* –∑–µ–ª—ë–Ω—ã–π */
      --goodSoft: rgba(47,191,113,.14);

      --pause: #E56B6F;         /* –º—è–≥–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π/–∫–æ—Ä–∞–ª–ª */
      --pauseSoft: rgba(229,107,111,.14);

      /* Accent for links / focus */
      --accent: #2F6FED;

      --radius: 22px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    [data-theme="dark"]{
      --bg: #0E1014;
      --card: #151822;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --line: rgba(255,255,255,.10);

      --goodSoft: rgba(47,191,113,.18);
      --pauseSoft: rgba(229,107,111,.18);
    }

    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    }

    .safe{
      padding-top: calc(14px + var(--safe-top));
      padding-bottom: calc(18px + var(--safe-bottom));
    }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
    }

    .btn{
      border-radius: 18px;
      transition: transform .08s ease, filter .08s ease, background .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }

    /* Tabs */
    .tabs{
      background: color-mix(in srgb, var(--card) 88%, transparent);
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow: hidden;
    }
    .tab{
      position: relative;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--muted);
      background: transparent;
      width: 100%;
      text-align: center;
    }
    .tab.is-active{
      color: var(--text);
      background: color-mix(in srgb, var(--card) 92%, transparent);
    }
    .tab.is-active::after{
      content:"";
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: 0;
      height: 2px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--text) 70%, transparent);
      opacity: .55;
    }

    /* Action buttons */
    .action{
      padding: 18px 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      font-weight: 650;
      font-size: 17px;
      border: 1px solid var(--line);
    }
    .action.good{ background: var(--goodSoft); }
    .action.pause{ background: var(--pauseSoft); }

    .icon{
      width: 18px;
      height: 18px;
      display:inline-block;
    }

    /* Dots row */
    .dots{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      padding: 10px 0 2px;
    }
    .dot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.06);
    }
    [data-theme="dark"] .dot{
      border: 1px solid rgba(255,255,255,.10);
    }
    .dot.good{ background: color-mix(in srgb, var(--good) 85%, white); }
    .dot.pause{ background: color-mix(in srgb, var(--pause) 85%, white); }

    /* Breathing */
    .breath-wrap{
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 18px 12px;
    }
    .breath-circle{
      width: 170px;
      height: 170px;
      border-radius: 999px;
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      color: white;
      font-weight: 650;
      letter-spacing: .2px;
      transform: scale(.78);
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
      overflow:hidden;
    }
    /* Gradient ‚Äú–∂–∏–≤–æ–π‚Äù —Ñ–æ–Ω */
    .breath-circle::before{
      content:"";
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.35), transparent 45%),
                  linear-gradient(135deg, #2FBF71, #2F6FED, #E56B6F);
      filter: saturate(1.05);
      animation: gradientShift 6s ease-in-out infinite alternate;
      transform: rotate(8deg);
    }
    @keyframes gradientShift{
      from{ transform: rotate(6deg) translateX(-6px); }
      to{ transform: rotate(14deg) translateX(6px); }
    }
    .breath-circle > span{
      position: relative;
      z-index: 2;
    }
    .breath-sub{
      color: var(--muted);
      font-size: 14px;
      text-align:center;
      line-height: 1.35;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      font-size: 13px;
    }

    /* Small ‚Äúsurprise note‚Äù */
    .note{
      border-left: 3px solid color-mix(in srgb, var(--accent) 60%, transparent);
      background: color-mix(in srgb, var(--card) 92%, transparent);
    }

    /* Buttons in settings */
    .seg{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    .seg button{
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      font-size: 14px;
      font-weight: 600;
    }
    .seg button.is-active{
      color: var(--text);
      background: color-mix(in srgb, var(--accent) 12%, var(--card));
      border-color: color-mix(in srgb, var(--accent) 20%, var(--line));
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-md mx-auto safe px-4 pb-10">

    <!-- Tabs -->
    <div class="tabs grid grid-cols-4 mb-4">
      <button class="tab is-active" data-tab="today">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="tab" data-tab="summary">–ò—Ç–æ–≥–∏</button>
      <button class="tab" data-tab="breath">–î—ã—Ö–∞–Ω–∏–µ</button>
      <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <!-- TODAY -->
    <section id="tab-today" class="fade">
      <div class="grid gap-4">
        <div class="card p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-[15px] font-semibold">–û—Ç–º–µ—Ç–∏—Ç—å –º–æ–º–µ–Ω—Ç</div>
              <div class="text-[13px] mt-1" style="color: var(--muted);">
                –ù–∏–∫–∞–∫–∏—Ö –æ—Ü–µ–Ω–æ–∫. –ü—Ä–æ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º ‚Äî –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á—É—Ç—å —è—Å–Ω–µ–µ.
              </div>
            </div>
            <div id="todayPill" class="pill">–°–µ–≥–æ–¥–Ω—è: ‚Äî</div>
          </div>

          <div class="grid gap-3 mt-4">
            <button id="btnGood" class="btn action good">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5v14M5 12h14" stroke="rgba(18,19,22,.80)" stroke-width="2.4" stroke-linecap="round"/>
              </svg>
              <span>–°–¥–µ–ª–∞–ª–∞ –ø–æ–ª–µ–∑–Ω–æ–µ</span>
            </button>

            <button id="btnPause" class="btn action pause">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M8 6v12M16 6v12" stroke="rgba(18,19,22,.80)" stroke-width="2.4" stroke-linecap="round"/>
              </svg>
              <span>–°–¥–µ–ª–∞–ª–∞ –ø–∞—É–∑—É</span>
            </button>
          </div>
        </div>

        <div class="card p-4">
          <div class="flex items-center justify-between gap-3">
            <div class="text-[15px] font-semibold">–°–µ–≥–æ–¥–Ω—è</div>
            <button id="btnClearToday" class="text-[13px] font-semibold" style="color: var(--accent);">
              –û—á–∏—Å—Ç–∏—Ç—å
            </button>
          </div>
          <div id="dots" class="dots mt-2"></div>
          <div class="text-[13px] mt-2" style="color: var(--muted);">
            –ú–∞–ª–µ–Ω—å–∫–∏–µ –æ—Ç–º–µ—Ç–∫–∏ ‚Äî —ç—Ç–æ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª—å. –≠—Ç–æ –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ.
          </div>
        </div>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="tab-summary" class="hidden">
      <div class="grid gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-[15px] font-semibold">–ò—Ç–æ–≥–∏ –¥–Ω—è</div>
              <div class="text-[13px] mt-1" style="color: var(--muted);">–ø–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –æ—Ç–º–µ—Ç–∫–∞–º</div>
            </div>
            <button id="btnGenDaily" class="btn px-4 py-2 text-[13px] font-semibold card" style="background: color-mix(in srgb, var(--accent) 10%, var(--card));">
              –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>

          <div id="surpriseDaily" class="hidden card note p-3 mt-3">
            <div class="text-[13px]" style="color: var(--muted);" id="surpriseDailyText"></div>
          </div>

          <pre id="dailyText" class="mt-3 whitespace-pre-wrap text-[14px] leading-relaxed p-3 rounded-2xl"
               style="background: color-mix(in srgb, var(--card) 88%, transparent); border: 1px solid var(--line);"></pre>

          <button id="btnSendDaily" class="mt-3 text-[13px] font-semibold" style="color: var(--accent);">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç
          </button>
        </div>

        <div class="card p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-[15px] font-semibold">–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏</div>
              <div class="text-[13px] mt-1" style="color: var(--muted);">–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
            </div>
            <button id="btnGenWeekly" class="btn px-4 py-2 text-[13px] font-semibold card" style="background: color-mix(in srgb, var(--accent) 10%, var(--card));">
              –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>

          <div id="surpriseWeekly" class="hidden card note p-3 mt-3">
            <div class="text-[13px]" style="color: var(--muted);" id="surpriseWeeklyText"></div>
          </div>

          <pre id="weeklyText" class="mt-3 whitespace-pre-wrap text-[14px] leading-relaxed p-3 rounded-2xl"
               style="background: color-mix(in srgb, var(--card) 88%, transparent); border: 1px solid var(--line);"></pre>

          <button id="btnSendWeekly" class="mt-3 text-[13px] font-semibold" style="color: var(--accent);">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç
          </button>
        </div>
      </div>
    </section>

    <!-- BREATH -->
    <section id="tab-breath" class="hidden">
      <div class="card p-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-[15px] font-semibold">–î—ã—Ö–∞–Ω–∏–µ 4‚Äì4‚Äì4‚Äì4</div>
            <div class="text-[13px] mt-1" style="color: var(--muted);">
              1 –º–∏–Ω—É—Ç–∞. –ú—è–≥–∫–æ –≤—ã—Ä–æ–≤–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
            </div>
          </div>
          <div class="pill" id="breathTimerPill">00:00 / 01:00</div>
        </div>

        <div class="breath-wrap mt-4">
          <div id="breathCircle" class="breath-circle">
            <span id="breathLabel">–ì–æ—Ç–æ–≤–∞</span>
          </div>

          <div class="breath-sub" id="breathHint">
            –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª. –î–∞–ª—å—à–µ –≤—Å—ë –ø–æ–π–¥—ë—Ç —Å–∞–º–æ.
          </div>

          <div class="flex gap-2 mt-2">
            <button id="breathStart" class="btn px-4 py-2 text-[14px] font-semibold card"
              style="background: color-mix(in srgb, var(--accent) 12%, var(--card));">
              –°—Ç–∞—Ä—Ç
            </button>
            <button id="breathStop" class="btn px-4 py-2 text-[14px] font-semibold card">
              –°—Ç–æ–ø
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="hidden">
      <div class="grid gap-4">
        <div class="card p-4">
          <div class="text-[15px] font-semibold">–¢–µ–º–∞</div>
          <div class="text-[13px] mt-1 mb-3" style="color: var(--muted);">
            –í—ã–±–µ—Ä–∏, –∫–∞–∫ —Ç–µ–±–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–µ–µ.
          </div>

          <div class="seg">
            <button data-theme="light" id="themeLight">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
            <button data-theme="dark" id="themeDark">üåô –¢—ë–º–Ω–∞—è</button>
            <button data-theme="system" id="themeSystem">‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω–∞—è</button>
          </div>
        </div>

        <div class="card p-4">
          <div class="text-[15px] font-semibold">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
          <div class="text-[14px] mt-2 leading-relaxed" style="color: var(--muted);">
            –≠—Ç–æ –º–∞–ª–µ–Ω—å–∫–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ—Ç–º–µ—Ç–æ–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.<br>
            <b style="color: var(--text);">–°–¥–µ–ª–∞–ª–∞ –ø–æ–ª–µ–∑–Ω–æ–µ</b> ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ—à—å —à–∞–≥ –≤ —Å–≤–æ—é —Å—Ç–æ—Ä–æ–Ω—É.<br>
            <b style="color: var(--text);">–°–¥–µ–ª–∞–ª–∞ –ø–∞—É–∑—É</b> ‚Äî —á–µ—Å—Ç–Ω–æ –æ—Ç–º–µ—á–∞–µ—à—å –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —É—à–ª–∞(—É—à—ë–ª) –≤ —Å—Ç–æ—Ä–æ–Ω—É –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–ª–æ —Ç—è–∂–µ–ª–æ.<br><br>
            –ö –≤–µ—á–µ—Ä—É –∏ –∫ –∫–æ–Ω—Ü—É –Ω–µ–¥–µ–ª–∏ –∏–∑ —ç—Ç–∏—Ö —Ç–æ—á–µ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ ‚Äî
            –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ª–µ–≥—á–µ —É–≤–∏–¥–µ—Ç—å, –ø–æ—á–µ–º—É –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
          </div>

          <div class="mt-3 text-[13px]" style="color: var(--muted);">
            –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ —Ç–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ/Telegram WebApp.
          </div>

          <button id="btnExport" class="mt-3 text-[13px] font-semibold" style="color: var(--accent);">
            –≠–∫—Å–ø–æ—Ä—Ç JSON
          </button>
          <pre id="exportBox" class="hidden mt-3 whitespace-pre-wrap text-[12px] leading-relaxed p-3 rounded-2xl"
               style="background: color-mix(in srgb, var(--card) 88%, transparent); border: 1px solid var(--line);"></pre>

          <button id="btnReset" class="mt-3 text-[13px] font-semibold" style="color: color-mix(in srgb, var(--pause) 80%, var(--text));">
            –°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ
          </button>
        </div>
      </div>
    </section>

  </div>

  <script>
    // -----------------------------
    // Telegram
    // -----------------------------
    const tg = window.Telegram?.WebApp;
    tg?.ready?.();
    tg?.expand?.();

    // -----------------------------
    // State
    // -----------------------------
    const STORAGE = "balancecare_v3";
    const todayKey = () => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    };

    const defaultState = () => ({
      theme: "system",
      events: [], // {date, type: "good"|"pause", ts}
      lastSurprise: { daily: null, weekly: null }
    });

    let state = (() => {
      try{
        const raw = localStorage.getItem(STORAGE);
        if(!raw) return defaultState();
        return { ...defaultState(), ...JSON.parse(raw) };
      }catch(e){
        return defaultState();
      }
    })();

    const save = () => localStorage.setItem(STORAGE, JSON.stringify(state));

    // -----------------------------
    // DOM helpers
    // -----------------------------
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    // -----------------------------
    // Tabs
    // -----------------------------
    function setTab(name){
      $$(".tab").forEach(b => b.classList.toggle("is-active", b.dataset.tab === name));
      ["today","summary","breath","settings"].forEach(t => {
        $("#tab-"+t).classList.toggle("hidden", t !== name);
      });

      // breath: stop when leaving
      if(name !== "breath") stopBreathing();
      if(name === "summary"){
        renderSummaries(true);
      }
    }

    $$(".tab").forEach(btn => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });

    // -----------------------------
    // Theme
    // -----------------------------
    function applyTheme(){
      const root = document.documentElement;

      if(state.theme === "system"){
        root.removeAttribute("data-theme");
      } else {
        root.setAttribute("data-theme", state.theme);
      }

      // active styles on theme buttons
      ["light","dark","system"].forEach(t => {
        const el = document.querySelector(`[data-theme="${t}"]`);
        el?.classList.toggle("is-active", state.theme === t);
      });
    }

    $$("[data-theme]").forEach(btn => {
      btn.addEventListener("click", () => {
        state.theme = btn.dataset.theme;
        save();
        applyTheme();
      });
    });

    // -----------------------------
    // Events (Today)
    // -----------------------------
    function addEvent(type){
      state.events.push({ date: todayKey(), type, ts: new Date().toISOString() });
      save();
      renderToday();
    }

    $("#btnGood").addEventListener("click", () => addEvent("good"));
    $("#btnPause").addEventListener("click", () => addEvent("pause"));

    $("#btnClearToday").addEventListener("click", () => {
      state.events = state.events.filter(e => e.date !== todayKey());
      save();
      renderToday();
    });

    function countForDate(d){
      const events = state.events.filter(e => e.date === d);
      const g = events.filter(e => e.type === "good").length;
      const p = events.filter(e => e.type === "pause").length;
      return { g, p, total: events.length, events };
    }

    function renderToday(){
      const { g, p, events } = countForDate(todayKey());

      // pill
      const pill = $("#todayPill");
      if(g+p === 0){
        pill.textContent = "–°–µ–≥–æ–¥–Ω—è: ‚Äî";
      } else {
        pill.textContent = `–°–µ–≥–æ–¥–Ω—è: ${g} + / ${p} ‚è∏`;
      }

      // dots
      const dots = $("#dots");
      dots.innerHTML = "";
      if(events.length === 0){
        const t = document.createElement("div");
        t.className = "text-[14px]";
        t.style.color = "var(--muted)";
        t.textContent = "–ü–æ–∫–∞ —Ç–∏—Ö–æ.";
        dots.appendChild(t);
        return;
      }

      events.slice(-40).forEach(e => {
        const d = document.createElement("div");
        d.className = "dot " + (e.type === "good" ? "good" : "pause");
        dots.appendChild(d);
      });
    }

    // -----------------------------
    // Summaries + Surprise notes
    // -----------------------------
    const surpriseDailyPool = [
      "–Ø –∑–∞–º–µ—Ç–∏–ª–∞: —Ç—ã —É–º–µ–µ—à—å –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–µ–±–µ ‚Äî –¥–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ —à–∞–≥–∞–º–∏. –≠—Ç–æ –æ—á–µ–Ω—å —Ü–µ–Ω–Ω–æ.",
      "–°–µ–≥–æ–¥–Ω—è —Ç—ã –Ω–µ –¥–æ–∫–∞–∑—ã–≤–∞–ª–∞ –Ω–∏—á–µ–≥–æ –º–∏—Ä—É. –¢—ã –ø—Ä–æ—Å—Ç–æ –±—ã–ª–∞ —Ä—è–¥–æ–º —Å —Å–æ–±–æ–π ‚Äî –∏ —ç—Ç–æ —É–∂–µ –ø–æ–±–µ–¥–∞.",
      "–ú–∞–ª–µ–Ω—å–∫–∞—è —á–µ—Å—Ç–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è —Å–¥–µ–ª–∞–ª–∞ –¥–µ–Ω—å –ª–µ–≥—á–µ. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –Ω–µ –±—Ä–æ—Å–∏–ª–∞ —Å–µ–±—è.",
      "–ü—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º: —É —Ç–µ–±—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è –±–µ—Ä–µ–∂–Ω–æ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –æ–ø–æ—Ä—É."
    ];

    const surpriseWeeklyPool = [
      "–ù–µ–¥–µ–ª—è –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –∂–∏–≤–∞—è. –ù–µ –∏–¥–µ–∞–ª—å–Ω–∞—è ‚Äî –Ω–∞—Å—Ç–æ—è—â–∞—è. –ò —ç—Ç–æ –∫—É–¥–∞ –≤–∞–∂–Ω–µ–µ.",
      "–¢—ã —Å–æ–±–∏—Ä–∞–µ—à—å —Å–µ–±—è –ø–æ —Ç–æ—á–∫–∞–º ‚Äî –∏ —ç—Ç–æ –æ—á–µ–Ω—å –≤–∑—Ä–æ—Å–ª—ã–π, —Å–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–¥—Ç–∏ –≤–ø–µ—Ä—ë–¥.",
      "–í–∏–∂—É —Ä–∏—Ç–º: —Ç—ã —Å—Ç–∞—Ä–∞–µ—à—å—Å—è. –ò —Ç—ã –Ω–µ –æ–¥–Ω–∞ –≤ —ç—Ç–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ.",
      "–¢–≤–æ—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å ‚Äî –Ω–µ ‚Äú–≤—Å–µ–≥–¥–∞‚Äù, –∞ ‚Äú–≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞‚Äù. –ò —Ç—ã —ç—Ç–æ –¥–µ–ª–∞–µ—à—å."
    ];

    function maybeShowSurprise(kind, dateKey){
      // kind: "daily" | "weekly"
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∫–æ (–ø—Ä–∏–º–µ—Ä–Ω–æ 35%), –∏ –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å –¥–ª—è daily / 1 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –¥–ª—è weekly
      const chance = 0.35;

      const last = state.lastSurprise?.[kind];
      const already = last === dateKey;

      const box = kind === "daily" ? $("#surpriseDaily") : $("#surpriseWeekly");
      const textEl = kind === "daily" ? $("#surpriseDailyText") : $("#surpriseWeeklyText");

      box.classList.add("hidden");

      if(already) return;
      if(Math.random() > chance) return;

      const pool = kind === "daily" ? surpriseDailyPool : surpriseWeeklyPool;
      const pick = pool[Math.floor(Math.random()*pool.length)];

      textEl.textContent = pick;
      box.classList.remove("hidden");

      state.lastSurprise[kind] = dateKey;
      save();
    }

    function generateDailyText(){
      const d = todayKey();
      const { g, p, events } = countForDate(d);

      if(events.length === 0){
        return `–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Ç–∏—Ö–æ ‚Äî –±–µ–∑ –æ—Ç–º–µ—Ç–æ–∫.\n\n–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–¥–µ–ª–∞–π –æ–¥–Ω—É –º–∞–ª–µ–Ω—å–∫—É—é –∑–∞–ø–∏—Å—å –∑–∞–≤—Ç—Ä–∞. –Ø —Ä—è–¥–æ–º.`;
      }

      const pattern = events.map(e => e.type === "good" ? "‚óè" : "‚óê").join(" ");
      // ‚óè = –ø–æ–ª–µ–∑–Ω–æ–µ, ‚óê = –ø–∞—É–∑–∞ (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ)
      if(g >= p){
        return `–ò—Ç–æ–≥–∏ –¥–Ω—è\n\n${pattern}\n\n–ü–æ–ª–µ–∑–Ω—ã—Ö —à–∞–≥–æ–≤: ${g}\n–ü–∞—É–∑—ã: ${p}\n\n–•–æ—Ä–æ—à–∏–π —Ä–∏—Ç–º. –î–∞–∂–µ –æ–¥–Ω–∞ ‚Äú—Ç–æ—á–∫–∞‚Äù ‚Äî —ç—Ç–æ —É–∂–µ –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ.`;
      } else {
        return `–ò—Ç–æ–≥–∏ –¥–Ω—è\n\n${pattern}\n\n–ü–æ–ª–µ–∑–Ω—ã—Ö —à–∞–≥–æ–≤: ${g}\n–ü–∞—É–∑—ã: ${p}\n\n–î–µ–Ω—å –º–æ–≥ –±—ã—Ç—å –Ω–µ–ø—Ä–æ—Å—Ç—ã–º. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–º–µ—Ç–∏–ª–∞. –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –Ω–æ–≤—ã–π —à–∞–Ω—Å ‚Äî –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è.`;
      }
    }

    function lastNDays(n){
      const out = [];
      const t = new Date();
      for(let i=0; i<n; i++){
        const d = new Date(t);
        d.setDate(t.getDate() - i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        out.push(`${yyyy}-${mm}-${dd}`);
      }
      return out.reverse();
    }

    function wd(iso){
      const d = new Date(iso+"T00:00:00");
      return ["–í—Å","–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±"][d.getDay()];
    }

    function generateWeeklyText(){
      const days = lastNDays(7);
      let gSum=0, pSum=0;

      const lines = days.map(d => {
        const { g, p, events } = countForDate(d);
        gSum += g; pSum += p;
        if(events.length === 0) return `${wd(d)}: ‚Äî`;
        const row = events.map(e => e.type === "good" ? "‚óè" : "‚óê").join("");
        return `${wd(d)}: ${row}`;
      }).join("\n");

      return `–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏\n\n–ü–æ–ª–µ–∑–Ω—ã—Ö —à–∞–≥–æ–≤: ${gSum}\n–ü–∞—É–∑—ã: ${pSum}\n\n–ö–∞—Ä—Ç–∞ –Ω–µ–¥–µ–ª–∏:\n${lines}\n\n–°–º—ã—Å–ª –Ω–µ –≤ –∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç–∏. –°–º—ã—Å–ª –≤ —Ç–æ–º, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å –∫–∞—Ä—Ç–∏–Ω—É ‚Äî –∏ –º–æ–∂–µ—à—å –º—è–≥–∫–æ –ø–æ–¥—Ä—É–ª–∏—Ç—å.`;
    }

    function renderSummaries(withSurprise=false){
      $("#dailyText").textContent = generateDailyText();
      $("#weeklyText").textContent = generateWeeklyText();

      if(withSurprise){
        maybeShowSurprise("daily", todayKey());
        // –∫–ª—é—á –Ω–µ–¥–µ–ª–∏: YYYY-Wxx (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
        const now = new Date();
        const year = now.getFullYear();
        const weekKey = `${year}-W${Math.ceil((((now - new Date(year,0,1)) / 86400000) + new Date(year,0,1).getDay()+1)/7)}`;
        maybeShowSurprise("weekly", weekKey);
      }
    }

    function sendToBot(kind, text){
      const payload = {
        kind,
        text,
        ts: new Date().toISOString(),
        date: todayKey()
      };

      if(tg && tg.sendData){
        tg.sendData(JSON.stringify(payload));
      } else {
        navigator.clipboard?.writeText(text).catch(()=>{});
      }
    }

    $("#btnGenDaily").addEventListener("click", () => renderSummaries(true));
    $("#btnGenWeekly").addEventListener("click", () => renderSummaries(true));
    $("#btnSendDaily").addEventListener("click", () => sendToBot("daily", $("#dailyText").textContent));
    $("#btnSendWeekly").addEventListener("click", () => sendToBot("weekly", $("#weeklyText").textContent));

    // -----------------------------
    // Breathing 4‚Äì4‚Äì4‚Äì4 (1 minute auto-stop)
    // -----------------------------
    const breathCircle = $("#breathCircle");
    const breathLabel  = $("#breathLabel");
    const breathHint   = $("#breathHint");
    const timerPill    = $("#breathTimerPill");

    let breathInterval = null;
    let breathElapsed = 0; // seconds
    let phaseIndex = 0;    // 0..3
    let secInPhase = 0;    // 0..3
    const MAX_SECONDS = 60;

    const phases = [
      { label: "–í–¥–æ—Ö",  mode:"in",   dur:4, from:.78, to:1.00 },
      { label: "–ü–∞—É–∑–∞", mode:"hold", dur:4, from:1.00, to:1.00 },
      { label: "–í—ã–¥–æ—Ö", mode:"out",  dur:4, from:1.00, to:.78 },
      { label: "–ü–∞—É–∑–∞", mode:"hold", dur:4, from:.78, to:.78 }
    ];

    function fmtTime(s){
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }

    function setScale(scale, smooth=true){
      breathCircle.style.transition = smooth ? "transform 1s linear" : "none";
      breathCircle.style.transform = `scale(${scale})`;
    }

    function updateBreathUI(){
      const phase = phases[phaseIndex];
      const progress = secInPhase / phase.dur; // 0..0.75
      const scale = phase.from + (phase.to - phase.from) * progress;

      setScale(scale, true);
      breathLabel.textContent = `${phase.label} ${secInPhase+1}`;
      breathHint.textContent = `4 ‚Ä¢ 4 ‚Ä¢ 4 ‚Ä¢ 4 ‚Äî —Å–ø–æ–∫–æ–π–Ω–æ, –±–µ–∑ —É—Å–∏–ª–∏–π`;

      timerPill.textContent = `${fmtTime(breathElapsed)} / 01:00`;
    }

    function startBreathing(){
      stopBreathing();

      breathElapsed = 0;
      phaseIndex = 0;
      secInPhase = 0;

      setScale(.78, false);
      breathLabel.textContent = "–í–¥–æ—Ö 1";
      breathHint.textContent = "–ú–æ–∂–µ—à—å –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å –∫—Ä—É–≥—É.";

      timerPill.textContent = "00:00 / 01:00";

      breathInterval = setInterval(() => {
        // auto-stop
        if(breathElapsed >= MAX_SECONDS){
          finishBreathing();
          return;
        }

        updateBreathUI();

        // tick
        breathElapsed++;
        secInPhase++;

        if(secInPhase >= phases[phaseIndex].dur){
          secInPhase = 0;
          phaseIndex = (phaseIndex + 1) % phases.length;
        }
      }, 1000);
    }

    function finishBreathing(){
      stopBreathing();
      breathLabel.textContent = "–ì–æ—Ç–æ–≤–æ";
      breathHint.textContent = "–•–æ—Ä–æ—à–æ. –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–∏–¥–µ—Ç—å –µ—â—ë –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ ‚Äî –∏ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ üôÇ";
      timerPill.textContent = "01:00 / 01:00";
      setScale(.90, true);
    }

    function stopBreathing(){
      if(breathInterval){
        clearInterval(breathInterval);
        breathInterval = null;
      }
    }

    $("#breathStart").addEventListener("click", startBreathing);
    $("#breathStop").addEventListener("click", stopBreathing);

    // -----------------------------
    // Settings: export / reset
    // -----------------------------
    $("#btnExport").addEventListener("click", () => {
      const box = $("#exportBox");
      box.classList.remove("hidden");
      box.textContent = JSON.stringify(state, null, 2);
    });

    $("#btnReset").addEventListener("click", () => {
      const ok = confirm("–°—Ç–µ—Ä–µ—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.");
      if(!ok) return;
      state = defaultState();
      save();
      $("#exportBox").classList.add("hidden");
      stopBreathing();
      applyTheme();
      renderToday();
      renderSummaries(false);
      setTab("today");
    });

    // -----------------------------
    // Init
    // -----------------------------
    applyTheme();
    renderToday();
    renderSummaries(false);
    setTab("today");
  </script>
</body>
</html>
